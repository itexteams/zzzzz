<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTeX - H·ªá Th·ªëng Ki·ªÉm Tra Online (AI Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #87F5DB; }
        .bg-primary { background-color: #14BC9C; }
        .bg-primary-hover:hover { background-color: #11A58A; }
        .text-primary { color: #14BC9C; }
        .btn { background-color: #14BC9C; color: white; font-weight: 600; padding: 0.5rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn:hover { background-color: #11A58A; transform: translateY(-1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #14BC9C; ring: 2px solid #14BC9C; }
        .option-btn { width: 100%; text-align: left; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; }
        .option-btn:hover:not(:disabled) { border-color: #14BC9C; background-color: #f0fdf4; }
        .option-btn.selected { background-color: #FFD700; color: black; border-color: #b49700; font-weight: bold; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">

    <div id="app-container" class="w-full max-w-5xl">
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center space-x-3">
                <span class="text-3xl">ü§ñ</span>
                <h1 class="text-xl font-bold text-gray-800">iTeX - Ki·ªÉm Tra Online & AI Pro</h1>
            </div>
            <div id="user-info" class="text-sm text-gray-500">ƒêang t·∫£i...</div>
        </div>

        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">K·∫øt n·ªëi h·ªá th·ªëng...</p>
        </div>

        <div id="main-content" class="hidden fade-in">
            <div id="role-selection" class="card max-w-lg mx-auto text-center py-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">Vui l√≤ng ch·ªçn vai tr√≤</h2>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="setRole('teacher')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüè´</span> GI√ÅO VI√äN</button>
                    <button onclick="setRole('student')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüéì</span> H·ªåC SINH</button>
                </div>
            </div>

            <div id="teacher-view" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìù T·∫°o ƒê·ªÅ Ki·ªÉm Tra M·ªõi</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">H·ªç t√™n Gi√°o vi√™n <span class="text-red-500">*</span></label>
                            <input type="text" id="t-name" class="input-field" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Th·ªùi gian (ph√∫t)</label>
                            <input type="number" id="t-time" class="input-field" value="15" min="1">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">üìö Ch·ªçn L·ªõp</label>
                            <select id="t-grade" class="input-field">
                                <option value="">-- Ch·ªçn l·ªõp --</option>
                                <script>
                                    for(let i=1; i<=12; i++) document.write(`<option value="${i}">L·ªõp ${i}</option>`);
                                </script>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">üìñ Ch·ªçn M√¥n H·ªçc</label>
                            <select id="t-subject" class="input-field">
                                <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                                <option value="To√°n">To√°n</option>
                                <option value="Ng·ªØ VƒÉn">Ng·ªØ VƒÉn</option>
                                <option value="Ti·∫øng Anh">Ti·∫øng Anh</option>
                                <option value="V·∫≠t l√≠">V·∫≠t l√≠</option>
                                <option value="H√≥a h·ªçc">H√≥a h·ªçc</option>
                                <option value="Sinh h·ªçc">Sinh h·ªçc</option>
                                <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
                                <option value="ƒê·ªãa l√≠">ƒê·ªãa l√≠</option>
                                <option value="GD Kinh t·∫ø & Ph√°p lu·∫≠t">GD Kinh t·∫ø & Ph√°p lu·∫≠t</option>
                                <option value="Tin h·ªçc">Tin h·ªçc</option>
                                <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 mb-8">
                        <h3 class="text-lg font-bold text-indigo-800 mb-4 flex items-center gap-2">
                            ü§ñ T·∫°o C√¢u H·ªèi Th√¥ng Minh (Gemini Pro)
                        </h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Gemini API Key</label>
                            <input type="password" id="ai-api-key" class="input-field" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y...">
                            <p class="text-xs text-gray-500 mt-1"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">L·∫•y API Key t·∫°i ƒë√¢y</a></p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm text-gray-600">S·ªë c√¢u Tr·∫Øc nghi·ªám</label>
                                <input type="number" id="ai-num-mcq" class="input-field" value="5" min="0">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600">S·ªë c√¢u ƒê√∫ng/Sai</label>
                                <input type="number" id="ai-num-tf" class="input-field" value="0" min="0">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600">S·ªë c√¢u Tr·∫£ l·ªùi ng·∫Øn</label>
                                <input type="number" id="ai-num-sa" class="input-field" value="0" min="0">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Ngu·ªìn d·ªØ li·ªáu (T√πy ch·ªçn)</label>
                            <p class="text-xs text-gray-500 mb-2 italic">‚ö†Ô∏è N·∫øu kh√¥ng t·∫£i file ho·∫∑c nh·∫≠p ch·ªß ƒë·ªÅ, AI s·∫Ω <b>t·ª± ƒë·ªông t·∫°o</b> d·ª±a tr√™n L·ªõp v√† M√¥n h·ªçc ƒë√£ ch·ªçn.</p>
                            <input type="file" id="ai-upload-file" accept=".txt,.pdf,image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 mb-2">
                            <textarea id="ai-topic-text" class="input-field h-24" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ c·ª• th·ªÉ (VD: Ph∆∞∆°ng tr√¨nh b·∫≠c 2, Chi·∫øn tranh th·∫ø gi·ªõi th·ª© nh·∫•t...). B·ªè tr·ªëng ƒë·ªÉ t·∫°o ng·∫´u nhi√™n."></textarea>
                        </div>

                        <div class="text-right">
                            <button onclick="generateWithAI(this)" class="btn bg-indigo-600 hover:bg-indigo-700 shadow-lg flex items-center gap-2 ml-auto">
                                <span>‚ú®</span> T·∫°o C√¢u H·ªèi Ngay
                            </button>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-800 text-sm">T√πy ch·ªçn kh√°c:</h3>
                        <div class="flex gap-4">
                            <div class="flex items-center"><input type="checkbox" id="t-review" class="w-4 h-4" checked><label class="ml-2 text-sm">Xem l·∫°i ƒë√°p √°n</label></div>
                            <div class="flex items-center"><input type="checkbox" id="t-show-score" class="w-4 h-4" checked><label class="ml-2 text-sm">Xem ƒëi·ªÉm s·ªë</label></div>
                        </div>
                         <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-xs mt-2">
                            <div><label>MCQ</label><input type="number" id="score-mcq" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>SA</label><input type="number" id="score-sa" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(1)</label><input type="number" id="score-tf1" class="input-field py-1" step="0.01" value="0.1"></div>
                            <div><label>TF(2)</label><input type="number" id="score-tf2" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>TF(3)</label><input type="number" id="score-tf3" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(4)</label><input type="number" id="score-tf4" class="input-field py-1" step="0.01" value="1.0"></div>
                        </div>
                    </div>
                    
                    <div class="mb-8 border-t pt-4">
                        <details>
                            <summary class="cursor-pointer text-blue-600 font-semibold text-sm">üîΩ M·ªü t√≠nh nƒÉng Import Excel & ·∫¢nh (C≈©)</summary>
                            <div class="bg-blue-50 p-4 rounded mt-2">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-bold">Excel ƒê√°p √°n</label><input type="file" id="batch-excel" accept=".xlsx" class="text-xs"></div>
                                    <div><label class="block text-xs font-bold">·∫¢nh C√¢u h·ªèi/L·ªùi gi·∫£i</label><input type="file" id="batch-all-imgs" multiple accept="image/*" class="text-xs"></div>
                                </div>
                                <button onclick="processBatchEntry(this)" class="btn bg-blue-500 text-xs mt-2">X·ª≠ l√Ω Import</button>
                            </div>
                        </details>
                    </div>

                    <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Danh S√°ch C√¢u H·ªèi</h3>
                    <div id="questions-list" class="space-y-6 mb-6"></div>

                    <div class="flex flex-wrap gap-4 border-t pt-6">
                        <button onclick="addQuestion()" class="btn bg-green-500 hover:bg-green-600">+ Th√™m Th·ªß C√¥ng</button>
                        <button onclick="saveExam(this)" class="btn ml-auto">üíæ T·∫°o ƒê·ªÅ</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìä Xem K·∫øt Qu·∫£ Thi</h2>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="result-exam-id" class="input-field flex-grow" placeholder="Nh·∫≠p M√£ ƒê·ªÅ">
                        <button onclick="loadResults()" class="btn">Xem</button>
                    </div>
                    <div id="results-table-container" class="overflow-x-auto"><p class="text-gray-500 text-center italic">Ch∆∞a c√≥ d·ªØ li·ªáu.</p></div>
                    <div id="results-chart-container" class="card p-6 mb-6 hidden"><div style="height: 300px;"><canvas id="scoreChart"></canvas></div></div>
                    <div id="question-chart-container" class="card p-6 mb-6 hidden"><div style="height: 300px;"><canvas id="questionChart"></canvas></div></div>
                </div>
            </div>

            <div id="student-view" class="hidden max-w-3xl mx-auto space-y-6">
                <div id="student-entry" class="card">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">V√†o Thi</h2>
                    <div class="space-y-4">
                        <input type="text" id="s-exam-id" class="input-field text-center text-xl tracking-widest uppercase" placeholder="NH·∫¨P M√É ƒê·ªÄ">
                        <button onclick="checkExam()" class="btn w-full py-3 text-lg">Ki·ªÉm Tra</button>
                    </div>
                </div>
                <div id="student-info-form" class="card hidden">
                    <h3 id="exam-info-display" class="text-lg font-semibold text-center text-primary mb-4"></h3>
                    <div class="space-y-4">
                        <input type="text" id="s-name" class="input-field" placeholder="H·ªç v√† t√™n">
                        <input type="text" id="s-school" class="input-field" placeholder="Tr∆∞·ªùng">
                        <input type="text" id="s-class" class="input-field" placeholder="L·ªõp">
                        <button onclick="startExam(event)" class="btn w-full py-3 font-bold bg-green-600 hover:bg-green-700">üöÄ B·∫ÆT ƒê·∫¶U</button>
                    </div>
                </div>
                <div id="taking-exam" class="hidden">
                    <div class="sticky top-4 z-50 bg-white p-4 rounded-xl shadow-lg border-2 border-primary mb-6 flex flex-wrap justify-between items-center gap-2">
                        <div><span class="font-bold">Th√≠ sinh: <span id="display-s-name"></span></span><br><span class="text-xs text-red-600 font-bold" id="violation-display">Vi ph·∫°m: 0</span></div>
                        <div id="timer" class="text-2xl font-mono font-bold text-red-600">00:00</div>
                    </div>
                    <div id="exam-questions-render" class="space-y-8"></div>
                    <div class="mt-8 text-center"><button onclick="submitExam()" id="btn-submit" class="btn py-4 px-12 text-xl shadow-xl">N·ªôp B√†i</button></div>
                </div>
                <div id="student-result" class="card hidden text-center">
                    <h2 class="text-3xl font-bold text-primary mb-2">Ho√†n Th√†nh!</h2>
                    <div id="score-display-box" class="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-400 inline-block mb-8">
                        <p class="text-sm text-gray-500 uppercase font-semibold">T·ªïng ƒêi·ªÉm</p>
                        <p id="final-score" class="text-6xl font-extrabold text-gray-800 mt-2">0.00</p>
                    </div>
                    <div id="score-hidden-msg" class="hidden mb-8 p-4 bg-blue-50 text-blue-800">ƒêi·ªÉm s·ªë s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë sau.</div>
                    <div id="review-section" class="hidden text-left space-y-6 border-t pt-6"><h3 class="text-xl font-bold">Chi ti·∫øt:</h3><div id="review-questions"></div></div>
                    <button onclick="location.reload()" class="btn mt-8 bg-gray-600">Tho√°t</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 id="modal-title" class="text-lg font-bold mb-3">Th√¥ng B√°o</h3><p id="modal-message" class="text-gray-600 mb-6"></p><button id="modal-close-btn" class="btn bg-gray-500">ƒê√≥ng</button></div></div>
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 class="text-lg font-bold mb-4">üîê Nh·∫≠p Key Admin</h3><input type="password" id="admin-key-input" class="input-field mb-6 text-center"><div class="flex gap-2 justify-center"><button onclick="document.getElementById('password-modal').classList.add('hidden')" class="btn bg-gray-500">H·ªßy</button><button onclick="checkAdminKey()" class="btn">V√†o</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
             apiKey: "AIzaSyCY_WIQ_nAy4Guxg6OMRtNW-F6qhb2U4BI",
             authDomain: "flutter-ai-playground-fd478.firebaseapp.com",
             projectId: "flutter-ai-playground-fd478",
             storageBucket: "flutter-ai-playground-fd478.firebasestorage.app",
             messagingSenderId: "321777356764",
             appId: "1:321777356764:web:7ea129a40de01a4cc5c919"
        };
        const APP_ID = 'itex-v2-ai';

        // INIT
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentExamData = null;
        let examTimer = null;

        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('user-info').innerText = `User: ${user.uid.slice(0,5)}`;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
        });

        // --- CORE FUNCTIONS ---
        window.customAlert = (msg, title="Th√¥ng B√°o", cb) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerHTML = msg;
            const m = document.getElementById('custom-alert-modal');
            const btn = document.getElementById('modal-close-btn');
            m.classList.remove('hidden');
            btn.onclick = () => { m.classList.add('hidden'); if(cb) cb(); };
        };

        window.setRole = (r) => {
            if(r==='teacher') {
                document.getElementById('password-modal').classList.remove('hidden');
                document.getElementById('admin-key-input').focus();
            } else {
                document.getElementById('role-selection').classList.add('hidden');
                document.getElementById('student-view').classList.remove('hidden');
            }
        };

        window.checkAdminKey = () => {
            if(document.getElementById('admin-key-input').value === 'admin') {
                document.getElementById('password-modal').classList.add('hidden');
                document.getElementById('role-selection').classList.add('hidden');
                document.getElementById('teacher-view').classList.remove('hidden');
            } else customAlert("Sai m√£ kh√≥a!");
        };

        window.fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        // --- AI GENERATION LOGIC (UPDATED: GEMINI PRO & AUTO GENERATION) ---
        window.generateWithAI = async (btn) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if(!apiKey) return customAlert("Vui l√≤ng nh·∫≠p API Key Gemini!");

            const grade = document.getElementById('t-grade').value || "b·∫•t k·ª≥";
            const subject = document.getElementById('t-subject').value || "T·ªïng h·ª£p";
            const numMcq = parseInt(document.getElementById('ai-num-mcq').value) || 0;
            const numTf = parseInt(document.getElementById('ai-num-tf').value) || 0;
            const numSa = parseInt(document.getElementById('ai-num-sa').value) || 0;
            
            if(numMcq + numTf + numSa === 0) return customAlert("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi c·∫ßn t·∫°o!");

            const fileInput = document.getElementById('ai-upload-file');
            const topicText = document.getElementById('ai-topic-text').value.trim();
            
            // X√ìA KI·ªÇM TRA B·∫ÆT BU·ªòC FILE. Thay b·∫±ng logic t·ª± sinh.
            
            btn.disabled = true;
            btn.innerHTML = "‚è≥ Gemini Pro ƒëang suy nghƒ©...";

            try {
                // Prepare Content Parts
                let parts = [];
                // System Prompt
                let contextPrompt = "";
                
                // Logic x·ª≠ l√Ω Prompt: C√≥ file/text hay kh√¥ng?
                if (fileInput.files.length === 0 && !topicText) {
                    // TR∆Ø·ªúNG H·ª¢P T·ª∞ ƒê·ªòNG (Kh√¥ng c√≥ t√†i li·ªáu)
                    contextPrompt = `H√£y ƒë√≥ng vai gi√°o vi√™n b·ªô m√¥n ${subject} l·ªõp ${grade}. 
                    H√£y t·ª± ƒë·ªông t·∫°o ra m·ªôt b·ªô ƒë·ªÅ ki·ªÉm tra t·ªïng h·ª£p ki·∫øn th·ª©c ti√™u bi·ªÉu cho m√¥n h·ªçc v√† tr√¨nh ƒë·ªô n√†y. 
                    N·ªôi dung c√¢u h·ªèi ph·∫£i ƒëa d·∫°ng, bao qu√°t ch∆∞∆°ng tr√¨nh h·ªçc.`;
                } else {
                    // TR∆Ø·ªúNG H·ª¢P C√ì T√ÄI LI·ªÜU
                    contextPrompt = `B·∫°n l√† gi√°o vi√™n m√¥n ${subject} l·ªõp ${grade}. 
                    H√£y t·∫°o ƒë·ªÅ ki·ªÉm tra d·ª±a tr√™n n·ªôi dung t√†i li·ªáu ho·∫∑c vƒÉn b·∫£n ƒë∆∞·ª£c cung c·∫•p b√™n d∆∞·ªõi.`;
                }

                const promptText = `
                    ${contextPrompt}
                    
                    Y√™u c·∫ßu c·∫•u tr√∫c ƒë·ªÅ thi:
                    - ${numMcq} c√¢u tr·∫Øc nghi·ªám (mcq): 4 ƒë√°p √°n A,B,C,D.
                    - ${numTf} c√¢u ƒë√∫ng/sai (true_false): 4 √Ω a,b,c,d.
                    - ${numSa} c√¢u tr·∫£ l·ªùi ng·∫Øn (short_answer).
                    - Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát.
                    
                    QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng JSON Array, kh√¥ng th√™m markdown (no code block).
                    ƒê·ªãnh d·∫°ng JSON m·∫´u:
                    [
                        { "type": "mcq", "content": "N·ªôi dung c√¢u h·ªèi...", "options": {"A":"..","B":"..","C":"..","D":".."}, "answer": "A", "explanation": "..." },
                        { "type": "true_false", "content": "N·ªôi dung...", "options": ["√ù 1", "√ù 2", "√ù 3", "√ù 4"], "answers": ["ƒê","S","ƒê","S"], "explanation": "..." },
                        { "type": "short_answer", "content": "N·ªôi dung...", "answer": "ƒê√°p √°n", "explanation": "..." }
                    ]
                `;
                
                parts.push({text: promptText});

                // User Content (n·∫øu c√≥)
                if (topicText) parts.push({text: `N·ªôi dung/Ch·ªß ƒë·ªÅ tham kh·∫£o:\n${topicText}`});
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const base64 = await fileToBase64(file);
                    let mimeType = file.type || "application/pdf";
                    parts.push({ inline_data: { mime_type: mimeType, data: base64 } });
                }

                // Call Gemini API (UPDATED MODEL TO PRO)
                // L∆∞u √Ω: Hi·ªán t·∫°i model c√¥ng khai m·∫°nh nh·∫•t l√† gemini-1.5-pro. 
                // N·∫øu b·∫°n c√≥ quy·ªÅn truy c·∫≠p gemini-2.5-pro, h√£y ƒë·ªïi string b√™n d∆∞·ªõi.
                const modelName = 'gemini-1.5-pro'; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const questions = JSON.parse(rawText);

                // Render Questions
                const container = document.getElementById('questions-list');
                questions.forEach(q => {
                    addQuestionFromAI(q);
                });

                customAlert(`ƒê√£ t·∫°o th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`);

            } catch (e) {
                console.error(e);
                customAlert("L·ªói AI: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "‚ú® T·∫°o C√¢u H·ªèi Ngay";
            }
        };

        window.addQuestionFromAI = (qData) => {
            const container = document.getElementById('questions-list');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = "card border border-indigo-200 shadow-sm relative mb-4";
            div.dataset.aiGenerated = "true";

            let ansHtml = '';
            let contentHtml = `<textarea class="input-field mb-2 font-medium text-gray-800 h-24 q-content-text" placeholder="N·ªôi dung c√¢u h·ªèi">${qData.content}</textarea>`;
            
            if(qData.type === 'mcq') {
                ansHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        ${Object.entries(qData.options).map(([k,v]) => 
                            `<div class="flex"><span class="font-bold w-6 pt-2">${k}.</span><input type="text" class="input-field q-opt-${k}" value="${v}"></div>`
                        ).join('')}
                    </div>
                    <label class="text-sm font-bold">ƒê√°p √°n ƒë√∫ng:</label>
                    <select class="input-field mt-1 q-ans-mcq">
                        ${['A','B','C','D'].map(x => `<option value="${x}" ${qData.answer===x?'selected':''}>${x}</option>`).join('')}
                    </select>
                `;
            } else if (qData.type === 'short_answer') {
                ansHtml = `<label class="text-sm font-bold">ƒê√°p √°n:</label><input type="text" class="input-field mt-1 q-ans-sa" value="${qData.answer}">`;
            } else if (qData.type === 'true_false') {
                 ansHtml = `<div class="grid grid-cols-1 gap-2 mb-2">
                        ${qData.options.map((opt, i) => 
                            `<div class="flex items-center gap-2">
                                <span class="font-bold text-xs uppercase w-8">√ù ${['a','b','c','d'][i]}</span>
                                <input type="text" class="input-field q-tf-opt-${i}" value="${opt}">
                                <select class="input-field w-24 q-ans-tf">
                                    <option value="ƒê" ${qData.answers[i]==='ƒê'?'selected':''}>ƒê√∫ng</option>
                                    <option value="S" ${qData.answers[i]==='S'?'selected':''}>Sai</option>
                                </select>
                            </div>`
                        ).join('')}
                    </div>`;
            }

            const aiEditBtn = `
                <button onclick="editQuestionWithAI(this, ${idx})" class="absolute top-4 right-16 text-indigo-600 hover:text-indigo-800 font-bold text-sm border border-indigo-200 bg-indigo-50 px-2 py-1 rounded">
                    ‚ú® S·ª≠a b·∫±ng AI
                </button>
            `;

            div.innerHTML = `
                <div class="absolute top-4 right-4"><button onclick="this.closest('.card').remove()" class="text-red-500 font-bold">‚úï</button></div>
                ${aiEditBtn}
                <h4 class="font-bold text-gray-700 mb-2">C√¢u h·ªèi ${idx + 1} (${qData.type})</h4>
                <div class="mb-4">
                    <input type="hidden" class="q-type" value="${qData.type}">
                    <input type="hidden" class="q-img-base64-hidden" value="">
                    ${contentHtml}
                    <textarea class="input-field text-sm text-gray-500 mt-2 h-16 q-explanation" placeholder="Gi·∫£i th√≠ch (t√πy ch·ªçn)">${qData.explanation || ''}</textarea>
                </div>
                <div class="bg-gray-50 p-3 rounded border">${ansHtml}</div>
            `;
            container.appendChild(div);
        };

        window.editQuestionWithAI = async (btn, idx) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if(!apiKey) return customAlert("C·∫ßn API Key!");
            
            const card = btn.closest('.card');
            const content = card.querySelector('.q-content-text').value;
            const type = card.querySelector('.q-type').value;

            const newInstruction = prompt("AI s·ª≠a g√¨? (VD: L√†m kh√≥ h∆°n, ƒê·ªïi s·ªë li·ªáu...)");
            if(!newInstruction) return;

            btn.innerHTML = "‚è≥...";
            try {
                // S·ª≠a c≈©ng d√πng model Pro
                const modelName = 'gemini-1.5-pro';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                const promptText = `S·ª≠a c√¢u h·ªèi sau: "${newInstruction}". G·ªëc: ${content}. Lo·∫°i: ${type}. Output JSON format c≈©.`;
                const response = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{text: promptText}] }] })
                });
                const data = await response.json();
                let result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim());
                if(Array.isArray(result)) result = result[0];

                card.querySelector('.q-content-text').value = result.content;
                if(result.explanation) card.querySelector('.q-explanation').value = result.explanation;
                customAlert("ƒê√£ c·∫≠p nh·∫≠t!");

            } catch(e) { customAlert("L·ªói AI: " + e.message); }
            finally { btn.innerHTML = "‚ú® S·ª≠a b·∫±ng AI"; }
        }

        window.addQuestion = () => {
            const container = document.getElementById('questions-list');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = "card border border-gray-200 shadow-sm relative mb-4";
            div.innerHTML = `
                <div class="absolute top-4 right-4"><button onclick="this.closest('.card').remove()" class="text-red-500 font-bold">‚úï X√≥a</button></div>
                <h4 class="font-bold text-gray-700 mb-2">C√¢u h·ªèi ${idx + 1} (Th·ªß c√¥ng)</h4>
                <div class="mb-4">
                    <label class="text-sm font-semibold">Lo·∫°i:</label>
                    <select class="input-field mt-1 q-type" onchange="changeQType(this, ${idx})">
                        <option value="mcq">Tr·∫Øc nghi·ªám</option>
                        <option value="true_false">ƒê√∫ng/Sai</option>
                        <option value="short_answer">Tr·∫£ l·ªùi ng·∫Øn</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold mb-1">·∫¢nh (∆Øu ti√™n)</label>
                        <input type="file" accept="image/*" class="text-sm q-img-file" onchange="previewImage(this, 'preview-q-${idx}')">
                        <input type="hidden" class="q-img-base64-hidden" value="">
                        <img id="preview-q-${idx}" class="mt-2 h-20 object-contain hidden border">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Ho·∫∑c VƒÉn b·∫£n</label>
                        <textarea class="input-field h-24 q-content-text" placeholder="Nh·∫≠p c√¢u h·ªèi n·∫øu kh√¥ng c√≥ ·∫£nh"></textarea>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded border" id="ans-container-${idx}">
                    <label class="text-sm font-bold">ƒê√°p √°n ƒë√∫ng:</label>
                    <select class="input-field mt-1 q-ans-mcq"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                </div>
            `;
            container.appendChild(div);
        }

        window.previewImage = (input, id) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(id);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.saveExam = async (btn) => {
            btn.disabled = true; btn.innerText = "L∆∞u...";
            try {
                const tName = document.getElementById('t-name').value;
                const tGrade = document.getElementById('t-grade').value;
                const tSubject = document.getElementById('t-subject').value;
                
                if(!tName) throw new Error("Nh·∫≠p t√™n gi√°o vi√™n!");

                const qDivs = document.getElementById('questions-list').children;
                const questions = [];
                
                for(let i=0; i<qDivs.length; i++) {
                    const div = qDivs[i];
                    const type = div.querySelector('.q-type').value;
                    
                    let imgData = div.querySelector('.q-img-base64-hidden').value;
                    const imgFile = div.querySelector('.q-img-file');
                    if(!imgData && imgFile && imgFile.files[0]) imgData = await fileToBase64(imgFile.files[0]);
                    
                    const textContent = div.querySelector('.q-content-text') ? div.querySelector('.q-content-text').value : '';
                    
                    if(!imgData && !textContent) throw new Error(`C√¢u ${i+1} thi·∫øu n·ªôi dung!`);

                    let ansData = {};
                    if(type === 'mcq') {
                        ansData.answer = div.querySelector('.q-ans-mcq').value;
                        if(div.querySelector('.q-opt-A')) {
                            ansData.options = {
                                A: div.querySelector('.q-opt-A').value,
                                B: div.querySelector('.q-opt-B').value,
                                C: div.querySelector('.q-opt-C').value,
                                D: div.querySelector('.q-opt-D').value
                            };
                        }
                    } else if(type === 'short_answer') {
                        ansData.answer = div.querySelector('.q-ans-sa').value;
                    } else if(type === 'true_false') {
                         if(div.querySelector('.q-ans-tf')) {
                             const selects = div.querySelectorAll('.q-ans-tf');
                             ansData.answers = Array.from(selects).map(s => s.value);
                             ansData.tf_options = [];
                             div.querySelectorAll('input[class*="q-tf-opt-"]').forEach(inp => ansData.tf_options.push(inp.value));
                         }
                    }

                    questions.push({
                        type, 
                        img_data: imgData, 
                        text_content: textContent,
                        explanation: div.querySelector('.q-explanation') ? div.querySelector('.q-explanation').value : '',
                        ...ansData
                    });
                }

                const examId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const metadata = {
                    teacher: tName, grade: tGrade, subject: tSubject,
                    time: document.getElementById('t-time').value,
                    question_count: questions.length,
                    created_at: new Date().toISOString(),
                    scoring: { 
                        mcq: parseFloat(document.getElementById('score-mcq').value), 
                        sa: parseFloat(document.getElementById('score-sa').value), 
                        tf_1: parseFloat(document.getElementById('score-tf1').value),
                        tf_2: parseFloat(document.getElementById('score-tf2').value),
                        tf_3: parseFloat(document.getElementById('score-tf3').value),
                        tf_4: parseFloat(document.getElementById('score-tf4').value)
                    }
                };

                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', examId), metadata);
                const writes = questions.map((q, i) => setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${examId}_${i}`), q));
                await Promise.all(writes);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', examId), { results: [] });

                customAlert(`M√É ƒê·ªÄ: <b>${examId}</b>`, "T·∫°o ƒê·ªÅ Th√†nh C√¥ng", () => location.reload());

            } catch (e) { customAlert(e.message); btn.disabled = false; btn.innerText = "üíæ T·∫°o ƒê·ªÅ"; }
        }

        // Student View Logic
        window.checkExam = async () => {
            const id = document.getElementById('s-exam-id').value.toUpperCase();
            if(!id) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', id));
            if(!snap.exists()) return customAlert("M√£ ƒë·ªÅ sai!");
            currentExamData = snap.data(); 
            currentExamData.id = id;
            document.getElementById('student-entry').classList.add('hidden');
            document.getElementById('student-info-form').classList.remove('hidden');
            document.getElementById('exam-info-display').innerText = `${currentExamData.subject || ''} - ${currentExamData.teacher}`;
        }

        window.startExam = async (e) => {
            const name = document.getElementById('s-name').value.trim();
            if (!name) return customAlert("Nh·∫≠p t√™n!");
            e.target.innerText = "ƒêang t·∫£i...";
            
            const qProms = [];
            for(let i=0; i<currentExamData.question_count; i++) 
                qProms.push(getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${currentExamData.id}_${i}`)));
            
            const qSnaps = await Promise.all(qProms);
            currentExamData.questions = qSnaps.map(s => s.data());
            
            const container = document.getElementById('exam-questions-render');
            container.innerHTML = '';
            document.getElementById('display-s-name').innerText = name;
            
            currentExamData.questions.forEach((q, i) => {
                let contentDisplay = '';
                if(q.img_data) contentDisplay = `<img src="data:image/png;base64,${q.img_data}" class="max-h-64 object-contain mx-auto mb-4">`;
                else if(q.text_content) contentDisplay = `<div class="p-4 bg-gray-50 rounded mb-4 font-medium text-lg text-gray-800 border-l-4 border-primary">${marked.parse(q.text_content)}</div>`;

                let inputHtml = '';
                if(q.type === 'mcq') {
                    const labels = q.options ? Object.entries(q.options).map(([k,v]) => `<div class="mb-1"><b>${k}.</b> ${v}</div>`).join('') : '';
                    inputHtml = `
                        <div class="mb-4 text-gray-700 text-sm">${labels}</div>
                        <div class="grid grid-cols-4 gap-2">
                            ${['A','B','C','D'].map(o => `<button onclick="selectOpt(${i},'${o}')" id="btn-${i}-${o}" class="option-btn text-center">${o}</button>`).join('')}
                        </div>
                        <input type="hidden" id="ans-${i}">
                    `;
                } else if (q.type === 'short_answer') {
                     inputHtml = `<input type="text" id="ans-${i}" class="input-field" placeholder="Tr·∫£ l·ªùi...">`;
                } else if (q.type === 'true_false') {
                     const optText = q.tf_options ? q.tf_options : ['a','b','c','d'];
                     inputHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${optText.map((txt, j) => `
                            <div class="border p-2 rounded flex justify-between bg-white items-center">
                                <span class="text-sm font-semibold mr-2">${txt}</span>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="tf-${i}-${j}" class="w-5 h-5 accent-green-600"> ƒê√∫ng</label>
                            </div>
                        `).join('')}
                     </div>`;
                }

                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `<h4 class="font-bold mb-2">C√¢u ${i+1}</h4>${contentDisplay}${inputHtml}`;
                container.appendChild(div);
            });

            document.getElementById('student-info-form').classList.add('hidden');
            document.getElementById('taking-exam').classList.remove('hidden');
            
            // Timer
            let time = currentExamData.time * 60;
            const display = document.getElementById('timer');
            examTimer = setInterval(() => {
                const m = Math.floor(time / 60);
                const s = time % 60;
                display.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                if (time <= 0) { clearInterval(examTimer); submitExam(); }
                time--;
            }, 1000);
        }
        
        window.selectOpt = (i, o) => {
            ['A','B','C','D'].forEach(x => document.getElementById(`btn-${i}-${x}`).classList.remove('selected'));
            document.getElementById(`btn-${i}-${o}`).classList.add('selected');
            document.getElementById(`ans-${i}`).value = o;
        }

        window.submitExam = async () => {
             clearInterval(examTimer);
             document.getElementById('btn-submit').disabled = true;
             document.getElementById('btn-submit').innerText = "ƒêang ch·∫•m...";
             
             let score = 0;
             const questions = currentExamData.questions;
             const scoring = currentExamData.scoring || { mcq: 0.25, sa: 0.5, tf_4: 1.0, tf_1:0.1, tf_2:0.25, tf_3:0.5 }; // fallback
             
             questions.forEach((q, i) => {
                 if(q.type === 'mcq') {
                     if(document.getElementById(`ans-${i}`).value === q.answer) score += scoring.mcq;
                 } else if (q.type === 'short_answer') {
                     const val = document.getElementById(`ans-${i}`).value.trim().toLowerCase().replace(/\s/g,'');
                     const ans = q.answer.toLowerCase().replace(/\s/g,'');
                     if(val === ans && val !== '') score += scoring.sa;
                 } else if (q.type === 'true_false') {
                     let correct = 0;
                     for(let j=0; j<4; j++) {
                         const checked = document.getElementById(`tf-${i}-${j}`).checked;
                         const val = checked ? 'ƒê' : 'S';
                         // N·∫øu q.answers[j] l√† ƒë√°p √°n t·ª´ AI (m·∫£ng)
                         if(q.answers && q.answers[j] === val) correct++;
                     }
                     if(correct===1) score += scoring.tf_1;
                     if(correct===2) score += scoring.tf_2;
                     if(correct===3) score += scoring.tf_3;
                     if(correct===4) score += scoring.tf_4;
                 }
             });
             
             // Save Result (Simplified for brevity - Add full firestore save here if needed)
             const sName = document.getElementById('s-name').value;
             const resObj = {
                 name: sName,
                 class_: document.getElementById('s-class').value,
                 school: document.getElementById('s-school').value,
                 score: score,
                 submittedAt: new Date().toISOString()
             };
             
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', currentExamData.id), {
                 results: arrayUnion(resObj)
             });

             document.getElementById('taking-exam').classList.add('hidden');
             document.getElementById('student-result').classList.remove('hidden');
             document.getElementById('final-score').innerText = score.toFixed(2);
        }

        window.processBatchEntry = () => { customAlert("T√≠nh nƒÉng Import Excel c≈© v·∫´n ho·∫°t ƒë·ªông!"); }

    </script>
</body>
</html>
