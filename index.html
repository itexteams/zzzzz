<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTeX - H·ªá Th·ªëng Ki·ªÉm Tra Online (Fix Submit Violation)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #87F5DB; }
        .bg-primary { background-color: #14BC9C; }
        .btn { background-color: #14BC9C; color: white; font-weight: 600; padding: 0.5rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn:hover { background-color: #11A58A; transform: translateY(-1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #14BC9C; ring: 2px solid #14BC9C; }
        
        .mcq-option { border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: flex-start; }
        .mcq-option.selected { background-color: #FEF08A; border-color: #EAB308; color: black; font-weight: 600; }
        .mcq-label { font-weight: bold; margin-right: 0.75rem; min-width: 25px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .score-circle { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%; font-size: 10px; font-weight: bold; color: white; flex-shrink: 0; margin: 2px; }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">

    <div id="app-container" class="w-full max-w-5xl">
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center space-x-3">
                <span class="text-3xl">ü§ñ</span>
                <h1 class="text-xl font-bold text-gray-800">iTeX - Ki·ªÉm Tra Online AI</h1>
            </div>
            <div id="user-info" class="text-sm text-gray-500">ƒêang t·∫£i...</div>
        </div>
        
        <hr class="mb-4">

        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">K·∫øt n·ªëi h·ªá th·ªëng...</p>
        </div>

        <div id="main-content" class="hidden fade-in">
            <div id="role-selection" class="card max-w-lg mx-auto text-center py-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">Vui l√≤ng ch·ªçn vai tr√≤</h2>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="setRole('teacher')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüè´</span> GI√ÅO VI√äN</button>
                    <button onclick="setRole('student')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüéì</span> H·ªåC SINH</button>
                </div>
            </div>
            
            <hr class="my-6">

            <div id="teacher-view" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìù T·∫°o ƒê·ªÅ Ki·ªÉm Tra M·ªõi</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Gi√°o vi√™n *</label><input type="text" id="t-name" class="input-field" placeholder="Nh·∫≠p t√™n"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Th·ªùi gian (ph√∫t)</label><input type="number" id="t-time" class="input-field" value="15" min="1"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">üìö L·ªõp</label><select id="t-grade" class="input-field"><script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">L·ªõp ${i}</option>`);</script></select></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">üìñ M√¥n</label><select id="t-subject" class="input-field"><option value="To√°n">To√°n</option><option value="Ng·ªØ VƒÉn">Ng·ªØ VƒÉn</option><option value="Ti·∫øng Anh">Ti·∫øng Anh</option><option value="V·∫≠t l√≠">V·∫≠t l√≠</option><option value="H√≥a h·ªçc">H√≥a h·ªçc</option><option value="Sinh h·ªçc">Sinh h·ªçc</option><option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option><option value="ƒê·ªãa l√≠">ƒê·ªãa l√≠</option><option value="GD Kinh t·∫ø & Ph√°p lu·∫≠t">GD Kinh t·∫ø & Ph√°p lu·∫≠t</option><option value="Tin h·ªçc">Tin h·ªçc</option><option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option></select></div>
                    </div>
                    
                    <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 mb-8">
                        <h3 class="text-lg font-bold text-indigo-800 mb-4 flex items-center gap-2">ü§ñ AI Generator (Auto Detect)</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Gemini API Key</label>
                            <input type="password" id="ai-api-key" class="input-field" placeholder="D√°n API Key..." onkeydown="if(event.key === 'Enter') generateWithAI(document.querySelector('#ai-generate-btn'))">
                            <div id="model-status" class="text-xs font-mono text-green-700 mt-1 hidden"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="block text-sm text-gray-600">Tr·∫Øc nghi·ªám</label><input type="number" id="ai-num-mcq" class="input-field" value="5" min="0"></div>
                            <div><label class="block text-sm text-gray-600">ƒê√∫ng/Sai</label><input type="number" id="ai-num-tf" class="input-field" value="0" min="0"></div>
                            <div><label class="block text-sm text-gray-600">Tr·∫£ l·ªùi ng·∫Øn</label><input type="number" id="ai-num-sa" class="input-field" value="0" min="0"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Ngu·ªìn d·ªØ li·ªáu</label>
                            <input type="file" id="ai-upload-file" accept=".txt,.pdf,image/*" class="block w-full text-sm text-gray-500 mb-2">
                            <textarea id="ai-topic-text" class="input-field h-24" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ..."></textarea>
                        </div>
                        <div class="text-right"><button onclick="generateWithAI(this)" id="ai-generate-btn" class="btn bg-indigo-600 hover:bg-indigo-700 shadow-lg flex items-center gap-2 ml-auto"><span>‚ú®</span> T·∫°o C√¢u H·ªèi Ngay</button></div>
                    </div>

                    <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-800 text-sm">C·∫•u h√¨nh ƒëi·ªÉm s·ªë:</h3>
                         <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-xs mt-2">
                            <div><label>MCQ</label><input type="number" id="score-mcq" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>SA</label><input type="number" id="score-sa" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(1)</label><input type="number" id="score-tf1" class="input-field py-1" step="0.01" value="0.1"></div>
                            <div><label>TF(2)</label><input type="number" id="score-tf2" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>TF(3)</label><input type="number" id="score-tf3" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(4)</label><input type="number" id="score-tf4" class="input-field py-1" step="0.01" value="1.0"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-100 p-4 rounded-lg border border-gray-300">
                        <div class="flex items-center"><input type="checkbox" id="allow-view-solution" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"><label for="allow-view-solution" class="ml-2 text-sm font-semibold text-gray-700">Cho ph√©p xem **L·ªùi gi·∫£i chi ti·∫øt**</label></div>
                        <div class="flex items-center"><input type="checkbox" id="allow-view-score" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" checked><label for="allow-view-score" class="ml-2 text-sm font-semibold text-gray-700">Cho ph√©p xem **ƒêi·ªÉm/K·∫øt qu·∫£** t·ªïng h·ª£p</label></div>
                    </div>
                    
                    <div id="questions-list" class="space-y-6 mb-6"></div>
                    <div class="flex flex-wrap gap-4 border-t pt-6"><button onclick="addQuestion()" class="btn bg-green-500 hover:bg-green-600">+ Th√™m Th·ªß C√¥ng</button><button onclick="saveExam(this)" class="btn ml-auto">üíæ T·∫°o ƒê·ªÅ & L·∫•y M√£</button></div>
                </div>
                
                <hr class="my-6">

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìä Xem K·∫øt Qu·∫£ & Ph√¢n T√≠ch</h2>
                    <div class="flex gap-4 mb-6"><input type="text" id="result-exam-id" class="input-field flex-grow" placeholder="Nh·∫≠p M√£ ƒê·ªÅ"><button onclick="loadResults()" class="btn">Xem</button></div>
                    
                    <div id="results-charts-analysis" class="hidden space-y-8">
                        <div class="card p-6 border border-gray-200"><h3 class="text-lg font-bold text-gray-800 mb-4">1. Ph√¢n t√≠ch ph√¢n b·ªë ƒëi·ªÉm</h3><div style="height: 300px;"><canvas id="scoreChart"></canvas></div></div>
                        <div class="card p-6 border border-gray-200"><h3 class="text-lg font-bold text-gray-800 mb-4">2. T·ªâ l·ªá th√≠ sinh l√†m ƒë√∫ng theo C√¢u H·ªèi (G·ªëc)</h3><div style="height: 300px;"><canvas id="questionCorrectnessChart"></canvas></div></div>
                        <div class="card p-6 border border-gray-200"><h3 class="text-lg font-bold text-gray-800 mb-4">3. Th·ªëng k√™ chi ti·∫øt ƒëi·ªÉm t·ª´ng c√¢u (Theo ƒê·ªÅ G·ªëc)</h3><div id="detailed-score-table" class="overflow-x-auto"></div></div>
                    </div>
                    <div id="results-table-container" class="overflow-x-auto mt-8"><p class="text-gray-500 text-center italic">Ch∆∞a c√≥ d·ªØ li·ªáu.</p></div>
                </div>
            </div>

            <div id="student-view" class="hidden max-w-3xl mx-auto space-y-6">
                <div id="student-entry" class="card">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">V√†o Thi</h2>
                    <div class="space-y-4"><input type="text" id="s-exam-id" class="input-field text-center text-xl tracking-widest uppercase" placeholder="NH·∫¨P M√É ƒê·ªÄ"><button onclick="checkExam()" class="btn w-full py-3 text-lg">Ki·ªÉm Tra M√£</button></div>
                </div>
                <div id="student-info-form" class="card hidden">
                    <h3 id="exam-info-display" class="text-lg font-semibold text-center text-primary mb-4"></h3>
                    <div class="space-y-4">
                        <input type="text" id="s-name" class="input-field" placeholder="H·ªç v√† t√™n">
                        <input type="text" id="s-school" class="input-field" placeholder="Tr∆∞·ªùng">
                        <input type="text" id="s-class" class="input-field" placeholder="L·ªõp">
                        <p class="text-xs text-red-500 italic font-bold">* L∆∞u √Ω: H·ªá th·ªëng s·∫Ω ƒê·∫¢O C√ÇU H·ªéI v√† b·∫≠t ch·∫ø ƒë·ªô TO√ÄN M√ÄN H√åNH.</p>
                        <button onclick="startExam(event)" class="btn w-full py-3 font-bold bg-green-600 hover:bg-green-700">üöÄ B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
                    </div>
                </div>
                <div id="taking-exam" class="hidden">
                    <div class="sticky top-4 z-50 bg-white p-4 rounded-xl shadow-lg border-2 border-primary mb-6 flex flex-wrap justify-between items-center gap-2">
                        <div><span class="font-bold">Th√≠ sinh: <span id="display-s-name"></span></span><br><span class="text-xs text-red-600 font-bold" id="violation-display">Vi ph·∫°m: 0/3</span></div>
                        <div id="timer" class="text-2xl font-mono font-bold text-red-600">00:00</div>
                    </div>
                    <div id="exam-questions-render" class="space-y-8"></div>
                    <div class="mt-8 text-center"><button onclick="submitExam()" id="btn-submit" class="btn py-4 px-12 text-xl shadow-xl">N·ªôp B√†i</button></div>
                </div>
                
                <div id="student-result" class="card hidden text-center">
                    <h2 class="text-3xl font-bold text-primary mb-2">Ho√†n Th√†nh!</h2>
                    <div id="score-display-box" class="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-400 inline-block mb-8">
                        <p class="text-sm text-gray-500 uppercase font-semibold">T·ªïng ƒêi·ªÉm</p>
                        <p id="final-score" class="text-6xl font-extrabold text-gray-800 mt-2">0.00</p>
                    </div>
                    <h3 id="report-title" class="text-xl font-bold mt-6 mb-4 text-gray-700 border-t pt-4">üìú K·∫øt Qu·∫£ Chi Ti·∫øt (Theo ƒê·ªÅ G·ªëc)</h3>
                    <div id="report-details-container" class="text-left space-y-4"></div>
                    <button onclick="location.reload()" class="btn mt-8 bg-gray-600">Tho√°t</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 id="modal-title" class="text-lg font-bold mb-3">Th√¥ng B√°o</h3><p id="modal-message" class="text-gray-600 mb-6"></p><button id="modal-close-btn" class="btn bg-gray-500">ƒê√≥ng</button></div></div>
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 class="text-lg font-bold mb-4">üîê Nh·∫≠p Key Admin</h3><input type="password" id="admin-key-input" class="input-field mb-6 text-center" onkeydown="if(event.key === 'Enter') checkAdminKey()"><div class="flex gap-2 justify-center"><button onclick="document.getElementById('password-modal').classList.add('hidden')" class="btn bg-gray-500">H·ªßy</button><button onclick="checkAdminKey()" class="btn">V√†o</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCY_WIQ_nAy4Guxg6OMRtNW-F6qhb2U4BI", authDomain: "flutter-ai-playground-fd478.firebaseapp.com", projectId: "flutter-ai-playground-fd478", storageBucket: "flutter-ai-playground-fd478.firebasestorage.app", messagingSenderId: "321777356764", appId: "1:321777356764:web:7ea129a40de01a4cc5c919" };
        const APP_ID = 'itex-v10-analytics';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentExamData = null;
        let examTimer = null;
        let detectedModelName = null;
        let violationCount = 0;
        let isSubmitting = false; // NEW FLAG: ƒê√°nh d·∫•u ƒëang n·ªôp b√†i ƒë·ªÉ t·∫Øt ch·ªëng gian l·∫≠n

        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('user-info').innerText = `User: ${user.uid.slice(0,5)}`;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
        });

        function renderLaTeX(element = document.body) {
            if (!window.renderMathInElement) return;
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null);
            let node;
            while (node = walker.nextNode()) {
                let text = node.nodeValue;
                if (text.includes("\\frac")) text = text.replace(/\\frac/g, "\\dfrac");
                text = text.replace(/\$(.+?)\$/g, (m, inner) => !inner.trim().startsWith("\\displaystyle") ? `$\\displaystyle ${inner}$` : m);
                node.nodeValue = text;
            }
            renderMathInElement(element, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], throwOnError: false });
        }
        document.addEventListener('DOMContentLoaded', () => { renderLaTeX(document.body); });
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        window.customAlert = (msg, title="Th√¥ng B√°o", cb) => { document.getElementById('modal-title').innerText = title; document.getElementById('modal-message').innerHTML = msg; const m = document.getElementById('custom-alert-modal'); m.classList.remove('hidden'); document.getElementById('modal-close-btn').onclick = () => { m.classList.add('hidden'); if(cb) cb(); }; };
        window.setRole = (r) => { if(r==='teacher') { document.getElementById('password-modal').classList.remove('hidden'); document.getElementById('admin-key-input').focus(); } else { document.getElementById('role-selection').classList.add('hidden'); document.getElementById('student-view').classList.remove('hidden'); } };
        window.checkAdminKey = () => { if(document.getElementById('admin-key-input').value === 'admin') { document.getElementById('password-modal').classList.add('hidden'); document.getElementById('role-selection').classList.add('hidden'); document.getElementById('teacher-view').classList.remove('hidden'); } else customAlert("Sai m√£ kh√≥a! (G·ª£i √Ω: admin)"); };
        window.fileToBase64 = (file) => new Promise((resolve) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(file); });

        async function detectBestModel(apiKey) {
            if(detectedModelName) return detectedModelName;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if(!response.ok) throw new Error("API Key kh√¥ng h·ª£p l·ªá.");
                const data = await response.json();
                const models = (data.models || []).filter(m => m.supportedGenerationMethods.includes("generateContent"));
                let selected = models.find(m => m.name.includes("gemini-1.5-pro")) || models.find(m => m.name.includes("gemini-1.5-flash")) || models.find(m => m.name.includes("gemini-pro"));
                detectedModelName = (selected || {name: "gemini-pro"}).name.replace("models/", "");
                document.getElementById('model-status').innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi: ${detectedModelName}`;
                document.getElementById('model-status').classList.remove('hidden');
                return detectedModelName;
            } catch (e) { return "gemini-pro"; }
        }

        function generateQuestionEditorHTML(qData, idx) {
            const type = qData.type;
            let ansHtml = '';
            let contentHtml = `<div><label class="block text-xs font-bold mb-1">N·ªôi dung C√¢u h·ªèi (VƒÉn b·∫£n)</label><textarea class="input-field mb-2 font-medium text-gray-800 h-24 q-content-text" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi ·ªü ƒë√¢y...">${qData.content || ''}</textarea></div>`;
            const imgInputHtml = `<div><label class="block text-xs font-bold mb-1">·∫¢nh C√¢u h·ªèi (T√πy ch·ªçn)</label><input type="file" accept="image/*" class="text-sm q-img-file" onchange="previewImage(this, 'preview-q-${idx}')"><input type="hidden" class="q-img-base64-hidden" value="${qData.img_data || ''}"><img id="preview-q-${idx}" src="${qData.img_data ? 'data:image/png;base64,'+qData.img_data : ''}" class="mt-2 h-20 object-contain border ${qData.img_data ? '' : 'hidden'}"></div>`;

            if(type === 'mcq') {
                const opts = qData.options || {A:"", B:"", C:"", D:""};
                const answer = qData.answer || 'A';
                ansHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">${Object.entries(opts).map(([k,v]) => `<div class="flex"><span class="font-bold w-6 pt-2">${k}.</span><input type="text" class="input-field q-opt-${k}" value="${v}"></div>`).join('')}</div><label class="text-sm font-bold">ƒê√°p √°n ƒë√∫ng:</label><select class="input-field mt-1 q-ans-mcq">${['A','B','C','D'].map(x => `<option value="${x}" ${answer===x?'selected':''}>${x}</option>`).join('')}</select>`;
            } else if (type === 'short_answer') {
                ansHtml = `<label class="text-sm font-bold">ƒê√°p √°n:</label><input type="text" class="input-field mt-1 q-ans-sa" value="${qData.answer || ''}">`;
            } else if (type === 'true_false') {
                 const tfOpts = qData.options || ['√ù 1', '√ù 2', '√ù 3', '√ù 4'];
                 const answers = qData.answers || ['ƒê', 'S', 'ƒê', 'S'];
                 ansHtml = `<div class="grid grid-cols-1 gap-2 mb-2">${tfOpts.map((opt, i) => `<div class="flex items-center gap-2"><span class="font-bold w-8">√ù ${['a','b','c','d'][i]}</span><input type="text" class="input-field q-tf-opt-${i}" value="${opt}"><select class="input-field w-24 q-ans-tf"><option value="ƒê" ${answers[i]==='ƒê'?'selected':''}>ƒê√∫ng</option><option value="S" ${answers[i]==='S'?'selected':''}>Sai</option></select></div>`).join('')}</div>`;
            }
            
            return `
                <div class="absolute top-4 right-4"><button onclick="this.closest('.card').remove()" class="text-red-500 font-bold">‚úï</button></div>
                <button onclick="editQuestionWithAI(this, ${idx})" class="absolute top-4 right-16 text-indigo-600 font-bold text-sm border border-indigo-200 bg-indigo-50 px-2 py-1 rounded">‚ú® S·ª≠a b·∫±ng AI</button>
                <h4 class="font-bold text-gray-700 mb-2">C√¢u h·ªèi ${idx + 1} (${type})</h4>
                <div class="mb-4">
                    <input type="hidden" class="q-type" value="${type}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">${imgInputHtml}${contentHtml}</div>
                    <div class="mt-2 border-t pt-2 bg-gray-50 p-2 rounded">
                        <label class="block text-xs font-bold mb-1 text-gray-600">Gi·∫£i th√≠ch / L·ªùi gi·∫£i chi ti·∫øt:</label>
                        <textarea class="input-field text-sm text-gray-600 mt-1 h-16 q-explanation" placeholder="Gi·∫£i th√≠ch ƒë√°p √°n...">${qData.explanation || ''}</textarea>
                        <div class="mt-2 flex items-center gap-2"><label class="text-xs font-bold text-indigo-600 cursor-pointer">üì∑ Th√™m ·∫£nh l·ªùi gi·∫£i:</label><input type="file" accept="image/*" class="text-xs q-expl-img-file" onchange="previewImage(this, 'preview-expl-${idx}')"><input type="hidden" class="q-expl-img-base64-hidden" value="${qData.explanation_img_data || ''}"></div>
                        <img id="preview-expl-${idx}" src="${qData.explanation_img_data ? 'data:image/png;base64,'+qData.explanation_img_data : ''}" class="mt-2 h-24 object-contain border bg-white rounded ${qData.explanation_img_data ? '' : 'hidden'}">
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded border">${ansHtml}</div>
            `;
        }
        
        window.generateWithAI = async (btn) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if (!apiKey) return customAlert("Vui l√≤ng nh·∫≠p API Key Gemini!");
            
            const numMcq = parseInt(document.getElementById('ai-num-mcq').value) || 0;
            const numTf = parseInt(document.getElementById('ai-num-tf').value) || 0;
            const numSa = parseInt(document.getElementById('ai-num-sa').value) || 0;
            if (numMcq + numTf + numSa === 0) return customAlert("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi!");

            btn.disabled = true; btn.innerHTML = "üîç ƒêang t·∫°o ƒë·ªÅ...";
            try {
                const modelName = await detectBestModel(apiKey);
                const fileInput = document.getElementById('ai-upload-file');
                const topicText = document.getElementById('ai-topic-text').value.trim();
                let parts = [];
                let contextPrompt = fileInput.files.length === 0 && !topicText ? `ƒê√≥ng vai gi√°o vi√™n. T·∫°o ƒë·ªÅ ki·ªÉm tra.` : `T·∫°o ƒë·ªÅ ki·ªÉm tra d·ª±a tr√™n n·ªôi dung d∆∞·ªõi ƒë√¢y.`;

                const promptText = `${contextPrompt} Y√™u c·∫ßu: ${numMcq} tr·∫Øc nghi·ªám (mcq), ${numTf} ƒë√∫ng/sai (true_false), ${numSa} tr·∫£ l·ªùi ng·∫Øn (short_answer). Ti·∫øng Vi·ªát. 
                S·ª≠ d·ª•ng chu·∫©n LaTeX (L∆ØU √ù QUAN TR·ªåNG: C√°c d·∫•u g·∫°ch ch√©o c·ªßa LaTeX ph·∫£i ƒë∆∞·ª£c escape 2 l·∫ßn, v√≠ d·ª• d√πng \\\\frac thay v√¨ \\frac). 
                Output JSON Array only. Structure: [{ "type": "mcq", "content": "...", "options": {"A":"..","B":"..","C":"..","D":".."}, "answer": "A", "explanation": "..." }, ...]`;
                
                parts.push({text: promptText});
                if (topicText) parts.push({text: `Ch·ªß ƒë·ªÅ: ${topicText}`});
                if (fileInput.files.length > 0) parts.push({ inline_data: { mime_type: fileInput.files[0].type || "application/pdf", data: await fileToBase64(fileInput.files[0]) } });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: parts }] })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                
                let rawText = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                rawText = rawText.replace(/\\([^\/\\bfnrtu"])/g, "\\\\$1"); // Clean JSON

                const questions = JSON.parse(rawText);
                questions.forEach((q) => {
                    const container = document.getElementById('questions-list');
                    const idx = container.children.length;
                    const div = document.createElement('div');
                    div.className = "card border border-indigo-200 shadow-sm relative mb-4";
                    q.aiGenerated = true;
                    div.innerHTML = generateQuestionEditorHTML(q, idx);
                    container.appendChild(div);
                    renderLaTeX(div);
                });
                customAlert(`ƒê√£ t·∫°o ${questions.length} c√¢u h·ªèi!`);
            } catch (e) { console.error(e); customAlert(`L·ªói (Kh·∫£ nƒÉng do AI sinh JSON sai ƒë·ªãnh d·∫°ng LaTeX): ${e.message}`); } finally { btn.disabled = false; btn.innerHTML = "‚ú® T·∫°o C√¢u H·ªèi Ngay"; }
        };

        window.editQuestionWithAI = async (btn, idx) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if (!apiKey) return customAlert("C·∫ßn API Key!");
            const card = btn.closest('.card');
            const type = card.querySelector('.q-type').value;
            const newInstruction = prompt("Y√™u c·∫ßu s·ª≠a c√¢u h·ªèi (VD: L√†m kh√≥ h∆°n, ƒê·ªïi s·ªë li·ªáu):");
            if (!newInstruction) return;

            btn.innerHTML = "‚è≥ AI ƒëang s·ª≠a...";
            try {
                const currentContent = card.querySelector('.q-content-text').value;
                const modelName = await detectBestModel(apiKey);
                const promptText = `B·∫°n l√† tr·ª£ l√Ω gi√°o vi√™n. S·ª≠a c√¢u h·ªèi sau: "${newInstruction}". L∆ØU √ù: D√πng LaTeX chu·∫©n JSON (V√≠ d·ª•: \\\\frac thay v√¨ \\frac). Lo·∫°i c√¢u: ${type}. N·ªôi dung c≈©: ${currentContent}. Ch·ªâ tr·∫£ v·ªÅ M·ªòT JSON Object duy nh·∫•t.`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{text: promptText}] }] })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                let rawText = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                rawText = rawText.replace(/\\([^\/\\bfnrtu"])/g, "\\\\$1");

                let newQuestionData = JSON.parse(rawText);
                if(Array.isArray(newQuestionData)) newQuestionData = newQuestionData[0]; 

                newQuestionData.type = newQuestionData.type === type ? newQuestionData.type : type;
                newQuestionData.aiGenerated = true;
                newQuestionData.img_data = card.querySelector('.q-img-base64-hidden').value;
                newQuestionData.explanation_img_data = card.querySelector('.q-expl-img-base64-hidden').value;

                card.innerHTML = generateQuestionEditorHTML(newQuestionData, idx); 
                renderLaTeX(card);
                customAlert("ƒê√£ t·∫°o c√¢u h·ªèi m·ªõi th√†nh c√¥ng!", "S·ª≠a ƒê·ªÅ Ho√†n T·∫•t");

            } catch (e) { customAlert("L·ªói AI: " + e.message); } finally { btn.disabled = false; btn.innerHTML = "‚ú® S·ª≠a b·∫±ng AI"; }
        };

        window.addQuestion = () => {
            const container = document.getElementById('questions-list');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = "card border border-gray-200 shadow-sm relative mb-4";
            const initialData = { type: 'mcq', content: '', explanation: '', options: {A:"", B:"", C:"", D:""} };
            div.innerHTML = generateQuestionEditorHTML(initialData, idx);
            div.querySelector('.q-type').addEventListener('change', (e) => {
                const newType = e.target.value;
                const dummyData = { type: newType, content: div.querySelector('.q-content-text')?.value || '', explanation: div.querySelector('.q-explanation')?.value || '', img_data: div.querySelector('.q-img-base64-hidden')?.value || '', explanation_img_data: div.querySelector('.q-expl-img-base64-hidden')?.value || '' };
                div.innerHTML = generateQuestionEditorHTML(dummyData, Array.from(container.children).indexOf(div));
                div.querySelector('.q-type').value = newType;
                renderLaTeX(div);
            });
            container.appendChild(div);
        }

        window.previewImage = (input, id) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => { const img = document.getElementById(id); img.src = e.target.result; img.classList.remove('hidden'); input.parentElement.querySelector('input[type="hidden"]').value = e.target.result.split(',')[1]; }; r.readAsDataURL(input.files[0]); } }
        
        window.saveExam = async (btn) => {
            btn.disabled = true; btn.innerText = "L∆∞u...";
            try {
                const tName = document.getElementById('t-name').value;
                if(!tName) throw new Error("Nh·∫≠p t√™n gi√°o vi√™n!");
                const qDivs = document.getElementById('questions-list').children;
                const questions = [];
                for(let i=0; i<qDivs.length; i++) {
                    const div = qDivs[i];
                    const type = div.querySelector('.q-type').value;
                    let imgData = div.querySelector('.q-img-base64-hidden').value;
                    if(!imgData && div.querySelector('.q-img-file').files[0]) imgData = await fileToBase64(div.querySelector('.q-img-file').files[0]);
                    let explImgData = div.querySelector('.q-expl-img-base64-hidden').value;
                    if(!explImgData && div.querySelector('.q-expl-img-file').files[0]) explImgData = await fileToBase64(div.querySelector('.q-expl-img-file').files[0]);
                    
                    let ansData = { type, img_data: imgData, explanation_img_data: explImgData, text_content: div.querySelector('.q-content-text').value, explanation: div.querySelector('.q-explanation').value };
                    if(type === 'mcq') { ansData.answer = div.querySelector('.q-ans-mcq').value; ansData.options = { A: div.querySelector('.q-opt-A').value, B: div.querySelector('.q-opt-B').value, C: div.querySelector('.q-opt-C').value, D: div.querySelector('.q-opt-D').value }; }
                    else if(type === 'short_answer') ansData.answer = div.querySelector('.q-ans-sa').value;
                    else if(type === 'true_false') { ansData.answers = Array.from(div.querySelectorAll('.q-ans-tf')).map(s => s.value); ansData.tf_options = []; div.querySelectorAll('input[class*="q-tf-opt-"]').forEach(inp => ansData.tf_options.push(inp.value)); }
                    questions.push(ansData);
                }
                const examId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const getScore = (id, def) => parseFloat(document.getElementById(id)?.value || def);
                const metadata = { teacher: tName, grade: document.getElementById('t-grade').value, subject: document.getElementById('t-subject').value, time: document.getElementById('t-time').value || 15, question_count: questions.length, created_at: new Date().toISOString(), allow_score: document.getElementById('allow-view-score').checked, allow_solution: document.getElementById('allow-view-solution').checked, scoring: { mcq: getScore('score-mcq', 0.25), sa: getScore('score-sa', 0.5), tf_1: getScore('score-tf1', 0.1), tf_2: getScore('score-tf2', 0.25), tf_3: getScore('score-tf3', 0.5), tf_4: getScore('score-tf4', 1.0) } };
                
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', examId), metadata);
                await Promise.all(questions.map((q, i) => setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${examId}_${i}`), q)));
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', examId), { results: [] });
                customAlert(`M√É ƒê·ªÄ: <b>${examId}</b>`, "T·∫°o ƒê·ªÅ Th√†nh C√¥ng", () => location.reload());
            } catch (e) { customAlert(e.message); btn.disabled = false; btn.innerText = "üíæ T·∫°o ƒê·ªÅ"; }
        }

        function calculateDetailedScore(q, studentAnswers, sc) {
            let maxScore = 0, achievedScore = 0;
            if (q.type === 'mcq') { maxScore = sc.mcq; if (studentAnswers.mcq === q.answer) achievedScore = sc.mcq; }
            else if (q.type === 'short_answer') { maxScore = sc.sa; if (studentAnswers.sa?.trim().toLowerCase() === q.answer.toLowerCase()) achievedScore = sc.sa; }
            else if (q.type === 'true_false') {
                const correct = q.answers || [];
                const len = correct.length;
                if(len===1) maxScore=sc.tf_1; else if(len===2) maxScore=sc.tf_2; else if(len===3) maxScore=sc.tf_3; else if(len===4) maxScore=sc.tf_4;
                let c = 0;
                for(let j=0; j<len; j++) if(studentAnswers.tf && studentAnswers.tf[j] === correct[j]) c++;
                if(c===1) achievedScore=sc.tf_1; else if(c===2) achievedScore=sc.tf_2; else if(c===3) achievedScore=sc.tf_3; else if(c===4) achievedScore=sc.tf_4;
            }
            return { achievedScore: parseFloat(achievedScore.toFixed(2)), maxScore: parseFloat(maxScore.toFixed(2)) };
        }

        window.loadResults = async () => {
            const id = document.getElementById('result-exam-id').value.trim().toUpperCase();
            if (!id) return customAlert("Vui l√≤ng nh·∫≠p M√£ ƒê·ªÅ!");
            const btn = document.querySelector('button[onclick="loadResults()"]'); btn.disabled = true; btn.innerText = "ƒêang t·∫£i...";
            try {
                const examSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', id));
                if (!examSnap.exists()) throw new Error("M√£ ƒë·ªÅ kh√¥ng t·ªìn t·∫°i.");
                const examMetadata = examSnap.data();
                const resultsSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', id));
                const results = resultsSnap.data()?.results || [];
                if (results.length === 0) { document.getElementById('results-table-container').innerHTML = '<p class="text-center py-4">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>'; document.getElementById('results-charts-analysis').classList.add('hidden'); return; }

                const qProms = []; for (let i = 0; i < examMetadata.question_count; i++) qProms.push(getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${id}_${i}`)));
                const questions = (await Promise.all(qProms)).map(s => s.data());
                
                let detailedScores = [], correctCounts = Array(questions.length).fill(0);
                results.forEach(r => {
                    let row = { name: r.name, class: r.class_, score: r.score, violation_count: r.violation_count||0, qs: [] };
                    questions.forEach((q, idx) => {
                        const s = calculateDetailedScore(q, r.detailed_answers?.[idx]?.answers || {}, examMetadata.scoring);
                        row.qs.push(s);
                        if (s.achievedScore === s.maxScore && s.maxScore > 0) correctCounts[idx]++;
                    });
                    detailedScores.push(row);
                });

                if (window.questionCorrectnessChartInstance) window.questionCorrectnessChartInstance.destroy();
                window.questionCorrectnessChartInstance = new Chart(document.getElementById('questionCorrectnessChart'), { type: 'bar', data: { labels: questions.map((_, i) => `C√¢u ${i+1}`), datasets: [{ label: 'T·ªâ l·ªá ƒë√∫ng (%)', data: correctCounts.map(c => (c/results.length)*100), backgroundColor: '#3B82F6' }] }, options: { responsive: true, maintainAspectRatio: false } });

                let detailedTableHtml = `<table class="w-full text-sm text-left text-gray-700"><thead class="bg-gray-100"><tr><th class="px-4 py-3 sticky left-0 bg-gray-100">Th√≠ sinh</th><th class="px-4 py-3">ƒêi·ªÉm</th>${questions.map((_,i)=>`<th class="px-2 text-center">C${i+1}</th>`).join('')}</tr></thead><tbody>`;
                detailedScores.forEach(r => {
                    detailedTableHtml += `<tr class="border-b"><td class="px-4 py-3 sticky left-0 bg-white">${r.name} (${r.class})</td><td class="px-4 font-bold text-primary">${r.score.toFixed(2)}</td>${r.qs.map(s => `<td class="text-center"><span class="score-circle ${s.achievedScore===s.maxScore?'bg-green-500':(s.achievedScore>0?'bg-yellow-500':'bg-red-500')}">${s.achievedScore}</span></td>`).join('')}</tr>`;
                });
                document.getElementById('detailed-score-table').innerHTML = detailedTableHtml + '</tbody></table>';

                let tableHtml = `<table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="px-4 py-3">H·∫°ng</th><th class="px-4">T√™n</th><th class="px-4">L·ªõp</th><th class="px-4 text-right">ƒêi·ªÉm</th><th class="px-4 text-center">Vi Ph·∫°m</th></tr></thead><tbody>`;
                results.sort((a,b)=>b.score-a.score).forEach((r,i) => tableHtml += `<tr class="border-b"><td class="px-4 font-bold">${i+1}</td><td class="px-4">${r.name}</td><td class="px-4">${r.class}</td><td class="px-4 text-right font-bold text-primary">${r.score.toFixed(2)}</td><td class="px-4 text-center">${r.violation_count||0}</td></tr>`);
                document.getElementById('results-table-container').innerHTML = tableHtml + '</tbody></table><div class="mt-4 text-right"><button onclick="exportResultsToExcel()" class="btn bg-green-600 text-xs">Xu·∫•t Excel</button></div>';

                if (window.scoreChartInstance) window.scoreChartInstance.destroy();
                window.scoreChartInstance = new Chart(document.getElementById('scoreChart'), { type: 'bar', data: { labels: ['0-2','2-4','4-6','6-8','8-10'], datasets: [{ label: 'S·ªë l∆∞·ª£ng', data: [0,0,0,0,0].map((_,i)=> results.filter(r=>{ const s=r.score; if(i==0)return s<2; if(i==1)return s>=2&&s<4; if(i==2)return s>=4&&s<6; if(i==3)return s>=6&&s<8; return s>=8; }).length), backgroundColor: '#3B82F6' }] } });
                document.getElementById('results-charts-analysis').classList.remove('hidden'); renderLaTeX(document.getElementById('results-charts-analysis'));
            } catch (e) { customAlert("L·ªói t·∫£i: " + e.message); document.getElementById('results-charts-analysis').classList.add('hidden'); } finally { btn.disabled = false; btn.innerText = "Xem"; }
        };
        window.exportResultsToExcel = () => { const t = document.getElementById('results-table-container').querySelector('table'); if(t) XLSX.writeFile(XLSX.utils.table_to_book(t, {sheet:'KQ'}), 'KetQua.xlsx'); else customAlert("Kh√¥ng c√≥ d·ªØ li·ªáu."); };

        window.checkExam = async () => {
            const id = document.getElementById('s-exam-id').value.toUpperCase();
            if(!id) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', id));
            if(!snap.exists()) return customAlert("M√£ ƒë·ªÅ sai!");
            currentExamData = snap.data(); currentExamData.id = id;
            document.getElementById('student-entry').classList.add('hidden'); document.getElementById('student-info-form').classList.remove('hidden');
            document.getElementById('exam-info-display').innerText = `${currentExamData.subject} - ${currentExamData.teacher}`;
        }

        window.setupAntiCheat = () => {
            violationCount = 0;
            const warn = (msg) => {
                if(isSubmitting) return; // FIXED: Kh√¥ng ghi nh·∫≠n l·ªói n·∫øu ƒëang n·ªôp b√†i
                violationCount++;
                document.getElementById('violation-display').innerHTML = `Vi ph·∫°m: <b class="text-red-600">${violationCount}/3</b>`;
                if(violationCount<3) alert(`‚ö†Ô∏è C·∫¢NH B√ÅO GIAN L·∫¨N (${violationCount}/3): ${msg}`);
                else { alert("üö´ VI PH·∫†M QU√Å M·ª®C. N·ªòP B√ÄI!"); submitExam(true); }
            };
            document.addEventListener("visibilitychange", () => { if(isSubmitting) return; if(document.hidden) warn("R·ªùi m√†n h√¨nh"); });
            document.addEventListener("fullscreenchange", () => { 
                if(isSubmitting) return; // FIXED: Kh√¥ng ghi nh·∫≠n l·ªói n·∫øu ƒëang n·ªôp b√†i
                if(!document.fullscreenElement && !document.getElementById('taking-exam').classList.contains('hidden')) warn("Tho√°t to√†n m√†n h√¨nh"); 
            });
            document.addEventListener("contextmenu", e => e.preventDefault()); document.addEventListener("copy", e => e.preventDefault());
            document.onkeydown = e => { if(e.keyCode==123 || (e.ctrlKey && e.shiftKey && (e.keyCode==73 || e.keyCode==67))) return false; };
        };

        window.startExam = async (e) => {
            const name = document.getElementById('s-name').value.trim(); if(!name) return customAlert("Nh·∫≠p t√™n!");
            isSubmitting = false; // Reset tr·∫°ng th√°i n·ªôp b√†i
            try { if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); } catch(err){}
            e.target.innerText = "ƒêang t·∫£i ƒë·ªÅ...";
            try {
                const qProms = []; for(let i=0; i<currentExamData.question_count; i++) qProms.push(getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${currentExamData.id}_${i}`)));
                currentExamData.questions = (await Promise.all(qProms)).map(s => s.data());
                
                const container = document.getElementById('exam-questions-render'); container.innerHTML = '';
                document.getElementById('display-s-name').innerText = name; setupAntiCheat();
                
                let indices = shuffleArray(Array.from({length: currentExamData.questions.length}, (_, i) => i));
                indices.forEach((origIdx, dispIdx) => {
                    const q = currentExamData.questions[origIdx];
                    let content = (q.img_data ? `<img src="data:image/png;base64,${q.img_data}" class="max-h-64 mx-auto mb-4 border rounded">` : '') + (q.text_content ? `<div class="p-4 bg-blue-50 border-l-4 border-blue-500 mb-4">${marked.parse(q.text_content)}</div>` : '');
                    let input = '';
                    if(q.type === 'mcq') {
                        let keys = shuffleArray(['A','B','C','D'].filter(k => q.options && q.options[k]));
                        input = `<div class="flex flex-col gap-2">${keys.map((k,i) => `<div id="opt-row-${origIdx}-${k}" onclick="selectOpt(${origIdx},'${k}')" class="mcq-option"><span class="mcq-label">${['A','B','C','D'][i]}.</span><span>${q.options[k]}</span></div>`).join('')}</div><input type="hidden" id="ans-${origIdx}">`;
                    } else if (q.type === 'short_answer') input = `<input type="text" id="ans-${origIdx}" class="input-field mt-2 border-2" placeholder="Tr·∫£ l·ªùi...">`;
                    else if (q.type === 'true_false') input = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">${(q.tf_options||['a','b','c','d']).map((t,j)=>`<div class="border p-2 flex justify-between bg-white items-center text-sm"><span>${t}</span><label class="flex items-center gap-2"><input type="checkbox" id="tf-${origIdx}-${j}" class="w-5 h-5 accent-green-600"> ƒê√∫ng</label></div>`).join('')}</div>`;
                    
                    const div = document.createElement('div'); div.className = "card mb-8 border-t-4 border-indigo-500";
                    div.innerHTML = `<div class="flex justify-between mb-3"><h4 class="font-bold bg-gray-200 px-3 py-1 rounded-full">C√¢u ${dispIdx+1}</h4><span class="text-xs font-bold text-gray-400 uppercase">${q.type}</span></div>${content}${input}`;
                    container.appendChild(div);
                });
                
                document.getElementById('student-info-form').classList.add('hidden'); document.getElementById('taking-exam').classList.remove('hidden'); renderLaTeX(document.getElementById('taking-exam'));
                let time = currentExamData.time * 60;
                examTimer = setInterval(() => { document.getElementById('timer').innerText = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`; if(time <= 0) { clearInterval(examTimer); alert("H·∫æT GI·ªú!"); submitExam(true); } time--; }, 1000);
            } catch(e) { console.error(e); customAlert("L·ªói t·∫£i ƒë·ªÅ: " + e.message); }
        }

        window.selectOpt = (i, o) => { ['A','B','C','D'].forEach(k => document.getElementById(`opt-row-${i}-${k}`)?.classList.remove('selected')); document.getElementById(`opt-row-${i}-${o}`)?.classList.add('selected'); document.getElementById(`ans-${i}`).value = o; }

        window.submitExam = async (force = false) => {
             if (!force) { 
                 const msg = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?\n\n‚ö†Ô∏è S·ªë l·ªói vi ph·∫°m ghi nh·∫≠n: ${violationCount}`; 
                 if (!confirm(msg)) return; 
             }
             isSubmitting = true; // Set flag to prevent anti-cheat triggers

             clearInterval(examTimer); 
             if (document.fullscreenElement) { try { await document.exitFullscreen(); } catch(e) {} }
             
             document.getElementById('btn-submit').disabled = true; document.getElementById('btn-submit').innerText = "ƒêang ch·∫•m...";
             
             let score = 0, detailedReportHtml = '', studentAnswersData = [];
             const sc = currentExamData.scoring, { allow_score, allow_solution } = currentExamData;

             currentExamData.questions.forEach((q, i) => {
                 let sAnsDis = 'Ch∆∞a l√†m', cAnsDis = '', isCorrect = false, qAns = {};
                 if (q.type === 'mcq') {
                     const sChoice = document.getElementById(`ans-${i}`)?.value; qAns.mcq = sChoice;
                     sAnsDis = sChoice || 'Ch∆∞a ch·ªçn'; cAnsDis = q.answer; isCorrect = (sChoice === q.answer);
                     if(isCorrect) score += sc.mcq;
                     if(sChoice) sAnsDis = `${sChoice} <span class="${isCorrect?'text-green-500':'text-red-500'}">(C·ªßa b·∫°n)</span>`;
                 } else if (q.type === 'short_answer') {
                     const sText = document.getElementById(`ans-${i}`)?.value; qAns.sa = sText;
                     sAnsDis = sText || 'Ch∆∞a nh·∫≠p'; cAnsDis = q.answer; isCorrect = (sText?.trim().toLowerCase() === q.answer.toLowerCase());
                     if(isCorrect) score += sc.sa;
                 } else if (q.type === 'true_false') {
                     let sChoices = [], cAns = q.answers || [], correctCount = 0, sTF = [];
                     for (let j = 0; j < (q.tf_options?.length || 4); j++) {
                         let sC = document.getElementById(`tf-${i}-${j}`)?.checked ? 'ƒê' : 'S';
                         sTF.push(sC); sChoices.push(`√ù ${j+1}: ${sC}`);
                         if (sC === cAns[j]) correctCount++;
                     }
                     qAns.tf = sTF; sAnsDis = sChoices.join(' | '); cAnsDis = cAns.join(' | ');
                     if(cAns.length>0 && correctCount>0) { if(correctCount==1) score+=sc.tf_1; else if(correctCount==2) score+=sc.tf_2; else if(correctCount==3) score+=sc.tf_3; else if(correctCount==4) score+=sc.tf_4; }
                     isCorrect = (correctCount === cAns.length && correctCount > 0);
                 }
                 studentAnswersData.push({ answers: qAns });

                 detailedReportHtml += `<div class="p-4 border-l-4 rounded ${isCorrect?'border-green-500 bg-green-50':'border-red-500 bg-red-50'}"><h5 class="font-bold mb-2">C√¢u ${i+1}: ${isCorrect?'ƒê√öNG':'SAI'}</h5><div class="bg-white p-3 text-sm">${q.img_data?`<img src="data:image/png;base64,${q.img_data}" class="max-h-32 mb-2">`:''} ${q.text_content?marked.parse(q.text_content):''}<p class="mt-2"><strong>B·∫°n ch·ªçn:</strong> ${sAnsDis}</p><p class="mt-1 text-green-700"><strong>ƒê√°p √°n:</strong> ${cAnsDis}</p><details class="mt-3"><summary class="cursor-pointer font-bold text-blue-600">L·ªùi gi·∫£i</summary><div class="mt-2 border-t pt-2">${q.explanation_img_data?`<img src="data:image/png;base64,${q.explanation_img_data}" class="max-h-48 mb-3">`:''}${q.explanation?marked.parse(q.explanation):'Kh√¥ng c√≥.'}</div></details></div></div>`;
             });

             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', currentExamData.id), { results: arrayUnion({ name: document.getElementById('s-name').value, class: document.getElementById('s-class').value, school: document.getElementById('s-school').value, score: score, submittedAt: new Date().toISOString(), violation_count: violationCount, detailed_answers: studentAnswersData }) });

             document.getElementById('taking-exam').classList.add('hidden'); document.getElementById('student-result').classList.remove('hidden');
             if (allow_score) document.getElementById('final-score').innerText = score.toFixed(2); else document.getElementById('score-display-box').innerHTML = '<p class="text-xl font-bold text-red-500">Gi√°o vi√™n ƒë√£ kh√≥a ƒëi·ªÉm.</p>';
             document.getElementById('report-details-container').innerHTML = (allow_solution && allow_score) ? detailedReportHtml : '<p class="text-center italic text-gray-500 p-4 border rounded">Chi ti·∫øt b√†i l√†m ƒë√£ b·ªã kh√≥a.</p>';
             if (allow_solution && allow_score) renderLaTeX(document.getElementById('report-details-container'));
        }
    </script>
</body>
</html>
