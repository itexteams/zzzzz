<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTeX - H·ªá Th·ªëng Ki·ªÉm Tra Online (Advanced Analytics)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #87F5DB; }
        .bg-primary { background-color: #14BC9C; }
        .btn { background-color: #14BC9C; color: white; font-weight: 600; padding: 0.5rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn:hover { background-color: #11A58A; transform: translateY(-1px); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #14BC9C; ring: 2px solid #14BC9C; }
        
        /* CSS CHO TR·∫ÆC NGHI·ªÜM */
        .mcq-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
        }
        .mcq-option.selected { background-color: #FEF08A; border-color: #EAB308; color: black; font-weight: 600; }
        .mcq-label { font-weight: bold; margin-right: 0.75rem; min-width: 25px; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* CSS cho h√¨nh tr√≤n ƒëi·ªÉm */
        .score-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin: 2px;
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">

    <div id="app-container" class="w-full max-w-5xl">
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center space-x-3">
                <span class="text-3xl">ü§ñ</span>
                <h1 class="text-xl font-bold text-gray-800">iTeX - Ki·ªÉm Tra Online AI</h1>
            </div>
            <div id="user-info" class="text-sm text-gray-500">ƒêang t·∫£i...</div>
        </div>
        
        <hr class="mb-4">

        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">K·∫øt n·ªëi h·ªá th·ªëng...</p>
        </div>

        <div id="main-content" class="hidden fade-in">
            <div id="role-selection" class="card max-w-lg mx-auto text-center py-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">Vui l√≤ng ch·ªçn vai tr√≤</h2>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="setRole('teacher')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüè´</span> GI√ÅO VI√äN</button>
                    <button onclick="setRole('student')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform"><span>üë®‚Äçüéì</span> H·ªåC SINH</button>
                </div>
            </div>
            
            <hr class="my-6">

            <div id="teacher-view" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìù T·∫°o ƒê·ªÅ Ki·ªÉm Tra M·ªõi</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Gi√°o vi√™n *</label><input type="text" id="t-name" class="input-field" placeholder="Nh·∫≠p t√™n"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Th·ªùi gian (ph√∫t)</label><input type="number" id="t-time" class="input-field" value="15" min="1"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">üìö L·ªõp</label><select id="t-grade" class="input-field"><script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">L·ªõp ${i}</option>`);</script></select></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">üìñ M√¥n</label><select id="t-subject" class="input-field"><option value="To√°n">To√°n</option><option value="Ng·ªØ VƒÉn">Ng·ªØ VƒÉn</option><option value="Ti·∫øng Anh">Ti·∫øng Anh</option><option value="V·∫≠t l√≠">V·∫≠t l√≠</option><option value="H√≥a h·ªçc">H√≥a h·ªçc</option><option value="Sinh h·ªçc">Sinh h·ªçc</option><option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option><option value="ƒê·ªãa l√≠">ƒê·ªãa l√≠</option><option value="GD Kinh t·∫ø & Ph√°p lu·∫≠t">GD Kinh t·∫ø & Ph√°p lu·∫≠t</option><option value="Tin h·ªçc">Tin h·ªçc</option><option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option></select></div>
                    </div>
                    
                    <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 mb-8">
                        <h3 class="text-lg font-bold text-indigo-800 mb-4 flex items-center gap-2">ü§ñ AI Generator (Auto Detect)</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Gemini API Key</label>
                            <input type="password" id="ai-api-key" class="input-field" placeholder="D√°n API Key..." 
                                   onkeydown="if(event.key === 'Enter') generateWithAI(document.querySelector('#ai-generate-btn'))">
                            <div id="model-status" class="text-xs font-mono text-green-700 mt-1 hidden"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="block text-sm text-gray-600">Tr·∫Øc nghi·ªám</label><input type="number" id="ai-num-mcq" class="input-field" value="5" min="0"></div>
                            <div><label class="block text-sm text-gray-600">ƒê√∫ng/Sai</label><input type="number" id="ai-num-tf" class="input-field" value="0" min="0"></div>
                            <div><label class="block text-sm text-gray-600">Tr·∫£ l·ªùi ng·∫Øn</label><input type="number" id="ai-num-sa" class="input-field" value="0" min="0"></div>
                        </div>
                        <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Ngu·ªìn d·ªØ li·ªáu</label><input type="file" id="ai-upload-file" accept=".txt,.pdf,image/*" class="block w-full text-sm text-gray-500 mb-2"><textarea id="ai-topic-text" class="input-field h-24" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ..."></textarea></div>
                        <div class="text-right"><button onclick="generateWithAI(this)" id="ai-generate-btn" class="btn bg-indigo-600 hover:bg-indigo-700 shadow-lg flex items-center gap-2 ml-auto"><span>‚ú®</span> T·∫°o C√¢u H·ªèi Ngay</button></div>
                    </div>

                    <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-gray-800 text-sm">C·∫•u h√¨nh ƒëi·ªÉm s·ªë:</h3>
                         <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-xs mt-2">
                            <div><label>MCQ</label><input type="number" id="score-mcq" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>SA</label><input type="number" id="score-sa" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(1)</label><input type="number" id="score-tf1" class="input-field py-1" step="0.01" value="0.1"></div>
                            <div><label>TF(2)</label><input type="number" id="score-tf2" class="input-field py-1" step="0.01" value="0.25"></div>
                            <div><label>TF(3)</label><input type="number" id="score-tf3" class="input-field py-1" step="0.01" value="0.5"></div>
                            <div><label>TF(4)</label><input type="number" id="score-tf4" class="input-field py-1" step="0.01" value="1.0"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-100 p-4 rounded-lg border border-gray-300">
                        <div class="flex items-center">
                            <input type="checkbox" id="allow-view-solution" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                            <label for="allow-view-solution" class="ml-2 text-sm font-semibold text-gray-700">Cho ph√©p xem **L·ªùi gi·∫£i chi ti·∫øt**</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="allow-view-score" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" checked>
                            <label for="allow-view-score" class="ml-2 text-sm font-semibold text-gray-700">Cho ph√©p xem **ƒêi·ªÉm/K·∫øt qu·∫£** t·ªïng h·ª£p</label>
                        </div>
                    </div>
                    
                    <div id="questions-list" class="space-y-6 mb-6"></div>
                    <div class="flex flex-wrap gap-4 border-t pt-6"><button onclick="addQuestion()" class="btn bg-green-500 hover:bg-green-600">+ Th√™m Th·ªß C√¥ng</button><button onclick="saveExam(this)" class="btn ml-auto">üíæ T·∫°o ƒê·ªÅ & L·∫•y M√£</button></div>
                </div>
                
                <hr class="my-6">

                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">üìä Xem K·∫øt Qu·∫£ & Ph√¢n T√≠ch</h2>
                    <div class="flex gap-4 mb-6"><input type="text" id="result-exam-id" class="input-field flex-grow" placeholder="Nh·∫≠p M√£ ƒê·ªÅ"><button onclick="loadResults()" class="btn">Xem</button></div>
                    
                    <div id="results-charts-analysis" class="hidden space-y-8">
                        
                        <div class="card p-6 border border-gray-200">
                             <h3 class="text-lg font-bold text-gray-800 mb-4">1. Ph√¢n t√≠ch ph√¢n b·ªë ƒëi·ªÉm</h3>
                             <div style="height: 300px;"><canvas id="scoreChart"></canvas></div>
                        </div>

                        <div class="card p-6 border border-gray-200">
                             <h3 class="text-lg font-bold text-gray-800 mb-4">2. T·ªâ l·ªá th√≠ sinh l√†m ƒë√∫ng theo C√¢u H·ªèi</h3>
                             <div style="height: 300px;"><canvas id="questionCorrectnessChart"></canvas></div>
                        </div>

                         <div class="card p-6 border border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">3. Th·ªëng k√™ chi ti·∫øt ƒëi·ªÉm t·ª´ng c√¢u</h3>
                            <div id="detailed-score-table" class="overflow-x-auto"></div>
                        </div>

                    </div>

                    <div id="results-table-container" class="overflow-x-auto mt-8">
                        <p class="text-gray-500 text-center italic">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
                    </div>

                </div>
            </div>

            <div id="student-view" class="hidden max-w-3xl mx-auto space-y-6">
                <div id="student-entry" class="card">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">V√†o Thi</h2>
                    <div class="space-y-4"><input type="text" id="s-exam-id" class="input-field text-center text-xl tracking-widest uppercase" placeholder="NH·∫¨P M√É ƒê·ªÄ"><button onclick="checkExam()" class="btn w-full py-3 text-lg">Ki·ªÉm Tra M√£</button></div>
                </div>
                <div id="student-info-form" class="card hidden">
                    <h3 id="exam-info-display" class="text-lg font-semibold text-center text-primary mb-4"></h3>
                    <div class="space-y-4"><input type="text" id="s-name" class="input-field" placeholder="H·ªç v√† t√™n"><input type="text" id="s-school" class="input-field" placeholder="Tr∆∞·ªùng"><input type="text" id="s-class" class="input-field" placeholder="L·ªõp"><button onclick="startExam(event)" class="btn w-full py-3 font-bold bg-green-600 hover:bg-green-700">üöÄ B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button></div>
                </div>
                <div id="taking-exam" class="hidden">
                    <div class="sticky top-4 z-50 bg-white p-4 rounded-xl shadow-lg border-2 border-primary mb-6 flex flex-wrap justify-between items-center gap-2">
                        <div><span class="font-bold">Th√≠ sinh: <span id="display-s-name"></span></span><br><span class="text-xs text-red-600 font-bold" id="violation-display">Vi ph·∫°m: 0/3</span></div>
                        <div id="timer" class="text-2xl font-mono font-bold text-red-600">00:00</div>
                    </div>
                    <div id="exam-questions-render" class="space-y-8"></div>
                    <div class="mt-8 text-center"><button onclick="submitExam()" id="btn-submit" class="btn py-4 px-12 text-xl shadow-xl">N·ªôp B√†i</button></div>
                </div>
                
                <div id="student-result" class="card hidden text-center">
                    <h2 class="text-3xl font-bold text-primary mb-2">Ho√†n Th√†nh!</h2>
                    <div id="score-display-box" class="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-400 inline-block mb-8">
                        <p class="text-sm text-gray-500 uppercase font-semibold">T·ªïng ƒêi·ªÉm</p>
                        <p id="final-score" class="text-6xl font-extrabold text-gray-800 mt-2">0.00</p>
                    </div>
                    
                    <h3 id="report-title" class="text-xl font-bold mt-6 mb-4 text-gray-700 border-t pt-4">üìú K·∫øt Qu·∫£ Chi Ti·∫øt T·ª´ng C√¢u</h3>
                    <div id="report-details-container" class="text-left space-y-4">
                        </div>

                    <button onclick="location.reload()" class="btn mt-8 bg-gray-600">Tho√°t</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 id="modal-title" class="text-lg font-bold mb-3">Th√¥ng B√°o</h3><p id="modal-message" class="text-gray-600 mb-6"></p><button id="modal-close-btn" class="btn bg-gray-500">ƒê√≥ng</button></div></div>
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center"><h3 class="text-lg font-bold mb-4">üîê Nh·∫≠p Key Admin</h3><input type="password" id="admin-key-input" class="input-field mb-6 text-center" onkeydown="if(event.key === 'Enter') checkAdminKey()"><div class="flex gap-2 justify-center"><button onclick="document.getElementById('password-modal').classList.add('hidden')" class="btn bg-gray-500">H·ªßy</button><button onclick="checkAdminKey()" class="btn">V√†o</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCY_WIQ_nAy4Guxg6OMRtNW-F6qhb2U4BI", authDomain: "flutter-ai-playground-fd478.firebaseapp.com", projectId: "flutter-ai-playground-fd478", storageBucket: "flutter-ai-playground-fd478.firebasestorage.app", messagingSenderId: "321777356764", appId: "1:321777356764:web:7ea129a40de01a4cc5c919" };
        const APP_ID = 'itex-v10-analytics';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentExamData = null;
        let examTimer = null;
        let detectedModelName = null;
        let violationCount = 0; // S·ªë l·ªói vi ph·∫°m c·ªßa h·ªçc sinh hi·ªán t·∫°i

        signInAnonymously(auth);
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('user-info').innerText = `User: ${user.uid.slice(0,5)}`;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
        });

        // --- MATHJAX/KATEX RENDERER (Configured) ---
        function renderLaTeX(element = document.body) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true}, 
                        {left: '\\[', right: '\\]', display: true}, 
                        {left: '$', right: '$', display: false},    
                        {left: '\\(', right: '\\)', display: false} 
                    ],
                    throwOnError: false
                });
            } else {
                console.warn("KaTeX auto-render not loaded. Math rendering disabled.");
            }
        }
        document.addEventListener('DOMContentLoaded', () => { renderLaTeX(document.body); });
        
        // --- HELPERS ---

        window.customAlert = (msg, title="Th√¥ng B√°o", cb) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerHTML = msg;
            const m = document.getElementById('custom-alert-modal');
            m.classList.remove('hidden');
            document.getElementById('modal-close-btn').onclick = () => { m.classList.add('hidden'); if(cb) cb(); };
        };

        window.setRole = (r) => {
            if(r==='teacher') { document.getElementById('password-modal').classList.remove('hidden'); document.getElementById('admin-key-input').focus(); } 
            else { document.getElementById('role-selection').classList.add('hidden'); document.getElementById('student-view').classList.remove('hidden'); }
        };

        window.checkAdminKey = () => {
            if(document.getElementById('admin-key-input').value === 'admin') {
                document.getElementById('password-modal').classList.add('hidden');
                document.getElementById('role-selection').classList.add('hidden');
                document.getElementById('teacher-view').classList.remove('hidden');
            } else customAlert("Sai m√£ kh√≥a! (G·ª£i √Ω: admin)");
        };

        window.fileToBase64 = (file) => new Promise((resolve) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(file); });

        async function detectBestModel(apiKey) {
            if(detectedModelName) return detectedModelName;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if(!response.ok) throw new Error("API Key kh√¥ng h·ª£p l·ªá.");
                const data = await response.json();
                const models = (data.models || []).filter(m => m.supportedGenerationMethods.includes("generateContent"));
                let selected = models.find(m => m.name.includes("gemini-1.5-pro")) || models.find(m => m.name.includes("gemini-1.5-flash")) || models.find(m => m.name.includes("gemini-pro"));
                if(!selected) return "gemini-pro";
                detectedModelName = selected.name.replace("models/", "");
                document.getElementById('model-status').innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi: ${detectedModelName}`;
                document.getElementById('model-status').classList.remove('hidden');
                return detectedModelName;
            } catch (e) { return "gemini-pro"; }
        }

        // --- H√†m t·∫°o HTML cho Editor (D√πng chung cho Add v√† Edit) ---
        function generateQuestionEditorHTML(qData, idx) {
            const type = qData.type;
            const isAi = qData.aiGenerated || false;

            let ansHtml = '';
            let contentHtml = `<textarea class="input-field mb-2 font-medium text-gray-800 h-24 q-content-text" placeholder="N·ªôi dung c√¢u h·ªèi">${qData.content || ''}</textarea>`;
            
            if(type === 'mcq') {
                const opts = qData.options || {A:"", B:"", C:"", D:""};
                const answer = qData.answer || 'A';
                ansHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">${Object.entries(opts).map(([k,v]) => `<div class="flex"><span class="font-bold w-6 pt-2">${k}.</span><input type="text" class="input-field q-opt-${k}" value="${v}"></div>`).join('')}</div><label class="text-sm font-bold">ƒê√°p √°n ƒë√∫ng:</label><select class="input-field mt-1 q-ans-mcq">${['A','B','C','D'].map(x => `<option value="${x}" ${answer===x?'selected':''}>${x}</option>`).join('')}</select>`;
            } else if (type === 'short_answer') {
                ansHtml = `<label class="text-sm font-bold">ƒê√°p √°n:</label><input type="text" class="input-field mt-1 q-ans-sa" value="${qData.answer || ''}">`;
            } else if (type === 'true_false') {
                 const tfOpts = qData.options || ['√ù 1', '√ù 2', '√ù 3', '√ù 4'];
                 const answers = qData.answers || ['ƒê', 'S', 'ƒê', 'S'];
                 ansHtml = `<div class="grid grid-cols-1 gap-2 mb-2">${tfOpts.map((opt, i) => `<div class="flex items-center gap-2"><span class="font-bold w-8">√ù ${['a','b','c','d'][i]}</span><input type="text" class="input-field q-tf-opt-${i}" value="${opt}"><select class="input-field w-24 q-ans-tf"><option value="ƒê" ${answers[i]==='ƒê'?'selected':''}>ƒê√∫ng</option><option value="S" ${answers[i]==='S'?'selected':''}>Sai</option></select></div>`).join('')}</div>`;
            }

            const isManual = !isAi;
            const imgInputHtml = isManual ? `<div><label class="block text-xs font-bold mb-1">·∫¢nh (T√πy ch·ªçn)</label><input type="file" accept="image/*" class="text-sm q-img-file" onchange="previewImage(this, 'preview-q-${idx}')"><input type="hidden" class="q-img-base64-hidden" value=""><img id="preview-q-${idx}" class="mt-2 h-20 object-contain hidden border"></div>` : `<input type="hidden" class="q-img-base64-hidden" value="">`;
            const contentInputHtml = isManual ? `<div><label class="block text-xs font-bold mb-1">Ho·∫∑c VƒÉn b·∫£n</label>${contentHtml}</div>` : contentHtml;
            
            return `
                <div class="absolute top-4 right-4"><button onclick="this.closest('.card').remove()" class="text-red-500 font-bold">‚úï</button></div>
                <button onclick="editQuestionWithAI(this, ${idx})" class="absolute top-4 right-16 text-indigo-600 font-bold text-sm border border-indigo-200 bg-indigo-50 px-2 py-1 rounded">‚ú® S·ª≠a b·∫±ng AI</button>
                <h4 class="font-bold text-gray-700 mb-2">C√¢u h·ªèi ${idx + 1} (${type})</h4>
                <div class="mb-4">
                    <input type="hidden" class="q-type" value="${type}">
                    ${isManual ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">${imgInputHtml} ${contentInputHtml}</div>` : contentInputHtml}
                    
                    <textarea class="input-field text-sm text-gray-500 mt-2 h-16 q-explanation" placeholder="Gi·∫£i th√≠ch">${qData.explanation || ''}</textarea>
                </div>
                <div class="bg-gray-50 p-3 rounded border">${ansHtml}</div>
            `;
        }
        
        // --- 1. AI GENERATION & EDITING ---
        window.generateWithAI = async (btn) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if (!apiKey) return customAlert("Vui l√≤ng nh·∫≠p API Key Gemini!");
            
            const numMcq = parseInt(document.getElementById('ai-num-mcq').value) || 0;
            const numTf = parseInt(document.getElementById('ai-num-tf').value) || 0;
            const numSa = parseInt(document.getElementById('ai-num-sa').value) || 0;
            if (numMcq + numTf + numSa === 0) return customAlert("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi!");

            btn.disabled = true; btn.innerHTML = "üîç ƒêang t·∫°o ƒë·ªÅ...";
            try {
                const modelName = await detectBestModel(apiKey);
                const fileInput = document.getElementById('ai-upload-file');
                const topicText = document.getElementById('ai-topic-text').value.trim();
                let parts = [];
                let contextPrompt = fileInput.files.length === 0 && !topicText 
                    ? `ƒê√≥ng vai gi√°o vi√™n ${document.getElementById('t-subject').value || 'M√¥n h·ªçc'} l·ªõp ${document.getElementById('t-grade').value || 'L·ªõp h·ªçc'}. T·∫°o ƒë·ªÅ ki·ªÉm tra t·ªïng h·ª£p.`
                    : `T·∫°o ƒë·ªÅ ki·ªÉm tra d·ª±a tr√™n n·ªôi dung d∆∞·ªõi ƒë√¢y.`;

                const promptText = `${contextPrompt} Y√™u c·∫ßu: ${numMcq} tr·∫Øc nghi·ªám (mcq), ${numTf} ƒë√∫ng/sai (true_false), ${numSa} tr·∫£ l·ªùi ng·∫Øn (short_answer). Ti·∫øng Vi·ªát. S·ª≠ d·ª•ng chu·∫©n LaTeX cho c√°c c√¥ng th·ª©c To√°n h·ªçc. Output JSON Array only (no markdown). Structure: [{ "type": "mcq", "content": "...", "options": {"A":"..","B":"..","C":"..","D":".."}, "answer": "A", "explanation": "..." }, { "type": "true_false", ...}, { "type": "short_answer", ...}]`;
                
                parts.push({text: promptText});
                if (topicText) parts.push({text: `Ch·ªß ƒë·ªÅ: ${topicText}`});
                if (fileInput.files.length > 0) parts.push({ inline_data: { mime_type: fileInput.files[0].type || "application/pdf", data: await fileToBase64(fileInput.files[0]) } });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: parts }] })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                const questions = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim());
                questions.forEach((q) => {
                    const container = document.getElementById('questions-list');
                    const idx = container.children.length;
                    const div = document.createElement('div');
                    div.className = "card border border-indigo-200 shadow-sm relative mb-4";
                    q.aiGenerated = true;
                    div.innerHTML = generateQuestionEditorHTML(q, idx);
                    container.appendChild(div);
                    renderLaTeX(div); // Render LaTeX cho th·∫ª m·ªõi
                });
                customAlert(`ƒê√£ t·∫°o ${questions.length} c√¢u h·ªèi!`);
            } catch (e) { customAlert(`L·ªói: ${e.message}`); } finally { btn.disabled = false; btn.innerHTML = "‚ú® T·∫°o C√¢u H·ªèi Ngay"; }
        };


        window.editQuestionWithAI = async (btn, idx) => {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            if (!apiKey) return customAlert("C·∫ßn API Key!");
            const card = btn.closest('.card');
            const type = card.querySelector('.q-type').value;

            const newInstruction = prompt("Y√™u c·∫ßu s·ª≠a c√¢u h·ªèi (VD: L√†m kh√≥ h∆°n, ƒê·ªïi s·ªë li·ªáu, S·ª≠a l·ªói ch√≠nh t·∫£):");
            if (!newInstruction) return;

            btn.innerHTML = "‚è≥ AI ƒëang s·ª≠a...";

            try {
                const currentContent = card.querySelector('.q-content-text').value;
                const modelName = await detectBestModel(apiKey);
                
                let jsonTemplate = '';
                if(type === 'mcq') jsonTemplate = `{"type": "mcq", "content": "C√¢u h·ªèi m·ªõi...", "options": {"A":"M·ªõi","B":"M·ªõi","C":"M·ªõi","D":"M·ªõi"}, "answer": "A", "explanation": "Gi·∫£i th√≠ch m·ªõi..."}`; 
                else if (type === 'true_false') jsonTemplate = `{"type": "true_false", "content": "C√¢u h·ªèi m·ªõi...", "options": ["√ù 1 m·ªõi", "√ù 2 m·ªõi", "√ù 3 m·ªõi", "√ù 4 m·ªõi"], "answers": ["ƒê","S","ƒê","S"], "explanation": "Gi·∫£i th√≠ch m·ªõi..."}`; 
                else jsonTemplate = `{"type": "short_answer", "content": "C√¢u h·ªèi m·ªõi...", "answer": "ƒê√°p √°n m·ªõi...", "explanation": "Gi·∫£i th√≠ch m·ªõi..."}`;
                
                const promptText = `
                    B·∫°n l√† m·ªôt tr·ª£ l√Ω gi√°o vi√™n. H√£y t·∫°o ra M·ªòT c√¢u h·ªèi m·ªõi ho√†n ch·ªânh d·ª±a tr√™n y√™u c·∫ßu: "${newInstruction}". S·ª≠ d·ª•ng chu·∫©n LaTeX cho c√°c c√¥ng th·ª©c To√°n h·ªçc.
                    
                    Lo·∫°i c√¢u h·ªèi g·ªëc: ${type}
                    N·ªôi dung c√¢u h·ªèi g·ªëc: ${currentContent}
                    
                    QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ M·ªòT ƒë·ªëi t∆∞·ª£ng JSON duy nh·∫•t theo ƒë√∫ng c·∫•u tr√∫c m·∫´u sau (Kh√¥ng d√πng d·∫•u backticks):
                    ${jsonTemplate}
                `;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{text: promptText}] }] })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                let rawText = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                let newQuestionData = JSON.parse(rawText);
                if(Array.isArray(newQuestionData)) newQuestionData = newQuestionData[0]; 

                newQuestionData.type = newQuestionData.type === type ? newQuestionData.type : type;
                newQuestionData.aiGenerated = true;

                // C·∫¨P NH·∫¨T UI B·∫∞NG C√ÅCH V·∫º L·∫†I TO√ÄN B·ªò CARD
                card.innerHTML = generateQuestionEditorHTML(newQuestionData, idx); 
                renderLaTeX(card); // Render LaTeX cho th·∫ª v·ª´a s·ª≠a

                customAlert("ƒê√£ t·∫°o c√¢u h·ªèi m·ªõi th√†nh c√¥ng!", "S·ª≠a ƒê·ªÅ Ho√†n T·∫•t");

            } catch (e) { 
                customAlert("L·ªói AI: " + e.message); 
            } finally { 
                btn.disabled = false; 
                btn.innerHTML = "‚ú® S·ª≠a b·∫±ng AI"; 
            }
        };

        // --- 2. MANUAL & SAVE ---
        window.addQuestion = () => {
            const container = document.getElementById('questions-list');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = "card border border-gray-200 shadow-sm relative mb-4";
            
            const initialData = { type: 'mcq', content: '', explanation: '', options: {A:"", B:"", C:"", D:""} };
            div.innerHTML = generateQuestionEditorHTML(initialData, idx);
            
            // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi lo·∫°i c√¢u h·ªèi (th·ªß c√¥ng)
            const typeSelect = div.querySelector('.q-type');
            typeSelect.addEventListener('change', (e) => {
                const newType = e.target.value;
                const dummyData = { type: newType, content: '', explanation: '' }; 
                
                // L·∫•y l·∫°i n·ªôi dung hi·ªán t·∫°i tr∆∞·ªõc khi re-render
                dummyData.content = div.querySelector('.q-content-text')?.value || '';
                dummyData.explanation = div.querySelector('.q-explanation')?.value || '';
                
                // Re-render the inner HTML with the new type's structure
                const currentIdx = Array.from(container.children).indexOf(div);
                div.innerHTML = generateQuestionEditorHTML(dummyData, currentIdx);
                div.querySelector('.q-type').value = newType;
                
                renderLaTeX(div); // Render LaTeX cho th·∫ª v·ª´a th√™m
            });

            container.appendChild(div);
        }

        window.previewImage = (input, id) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => { document.getElementById(id).src = e.target.result; document.getElementById(id).classList.remove('hidden'); }; r.readAsDataURL(input.files[0]); } }

        window.saveExam = async (btn) => {
            btn.disabled = true; btn.innerText = "L∆∞u...";
            try {
                const tNameInput = document.getElementById('t-name');
                if(!tNameInput || !tNameInput.value) throw new Error("Nh·∫≠p t√™n gi√°o vi√™n!");
                const tName = tNameInput.value;
                
                const qDivs = document.getElementById('questions-list').children;
                const questions = [];
                
                for(let i=0; i<qDivs.length; i++) {
                    const div = qDivs[i];
                    const type = div.querySelector('.q-type')?.value || 'mcq';
                    
                    let imgData = div.querySelector('.q-img-base64-hidden')?.value || '';
                    const imgFile = div.querySelector('.q-img-file');
                    if(!imgData && imgFile?.files[0]) imgData = await fileToBase64(imgFile.files[0]);
                    
                    let ansData = { 
                        type, 
                        img_data: imgData, 
                        text_content: div.querySelector('.q-content-text')?.value || '', 
                        explanation: div.querySelector('.q-explanation')?.value || '' 
                    };
                    
                    if(type === 'mcq') {
                        ansData.answer = div.querySelector('.q-ans-mcq')?.value || 'A';
                        
                        const optA = div.querySelector('.q-opt-A')?.value || '';
                        const optB = div.querySelector('.q-opt-B')?.value || '';
                        const optC = div.querySelector('.q-opt-C')?.value || '';
                        const optD = div.querySelector('.q-opt-D')?.value || '';
                        
                        if(optA || optB || optC || optD) { 
                            ansData.options = { A: optA, B: optB, C: optC, D: optD };
                        }
                        
                    } else if(type === 'short_answer') {
                        ansData.answer = div.querySelector('.q-ans-sa')?.value || '';
                    } else if(type === 'true_false') {
                        const selects = div.querySelectorAll('.q-ans-tf');
                        ansData.answers = Array.from(selects).map(s => s.value);
                        ansData.tf_options = []; 
                        div.querySelectorAll('input[class*="q-tf-opt-"]').forEach(inp => ansData.tf_options.push(inp.value));
                    }
                    questions.push(ansData);
                }
                const examId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const getScoreValue = (id, fallback) => parseFloat(document.getElementById(id)?.value || fallback);
                
                const metadata = {
                    teacher: tName, grade: document.getElementById('t-grade').value, subject: document.getElementById('t-subject').value,
                    time: document.getElementById('t-time')?.value || 15, question_count: questions.length, created_at: new Date().toISOString(),
                    // C·∫•u h√¨nh quy·ªÅn xem k·∫øt qu·∫£
                    allow_score: document.getElementById('allow-view-score').checked,
                    allow_solution: document.getElementById('allow-view-solution').checked,
                    scoring: { 
                        mcq: getScoreValue('score-mcq', 0.25), sa: getScoreValue('score-sa', 0.5), 
                        tf_1: getScoreValue('score-tf1', 0.1), tf_2: getScoreValue('score-tf2', 0.25),
                        tf_3: getScoreValue('score-tf3', 0.5), tf_4: getScoreValue('score-tf4', 1.0)
                    }
                };
                
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', examId), metadata);
                const writes = questions.map((q, i) => setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${examId}_${i}`), q));
                await Promise.all(writes);
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', examId), { results: [] });
                customAlert(`M√É ƒê·ªÄ: <b>${examId}</b>`, "T·∫°o ƒê·ªÅ Th√†nh C√¥ng", () => location.reload());
            } catch (e) { customAlert(e.message); btn.disabled = false; btn.innerText = "üíæ T·∫°o ƒê·ªÅ"; }
        }

        // H√†m ch·∫•m ƒëi·ªÉm chi ti·∫øt cho Teacher Analytics (t√≠nh ƒëi·ªÉm t·ª´ng c√¢u)
        function calculateDetailedScore(q, studentAnswers, scoring) {
            let maxScore = 0;
            let achievedScore = 0;
            const sc = scoring;

            if (q.type === 'mcq') {
                maxScore = sc.mcq;
                if (studentAnswers.mcq === q.answer) achievedScore = sc.mcq;
            } else if (q.type === 'short_answer') {
                maxScore = sc.sa;
                if (studentAnswers.sa?.trim().toLowerCase() === q.answer.toLowerCase()) achievedScore = sc.sa;
            } else if (q.type === 'true_false') {
                const correctAnswers = q.answers || [];
                const numOptions = correctAnswers.length;
                if (numOptions > 0) {
                    // T√πy thu·ªôc s·ªë l∆∞·ª£ng √Ω, ƒëi·ªÉm t·ªëi ƒëa s·∫Ω kh√°c nhau
                    if (numOptions === 1) maxScore = sc.tf_1;
                    else if (numOptions === 2) maxScore = sc.tf_2;
                    else if (numOptions === 3) maxScore = sc.tf_3;
                    else if (numOptions === 4) maxScore = sc.tf_4;

                    let correctCount = 0;
                    for (let j = 0; j < numOptions; j++) {
                        if (studentAnswers.tf && studentAnswers.tf[j] === correctAnswers[j]) {
                            correctCount++;
                        }
                    }

                    // Ch·∫•m ƒëi·ªÉm theo s·ªë l∆∞·ª£ng √Ω ƒë√∫ng ƒë·∫°t ƒë∆∞·ª£c
                    if (correctCount === 1) achievedScore = sc.tf_1;
                    else if (correctCount === 2) achievedScore = sc.tf_2;
                    else if (correctCount === 3) achievedScore = sc.tf_3;
                    else if (correctCount === 4) achievedScore = sc.tf_4;
                    // Note: N·∫øu s·ªë √Ω ƒë√∫ng l√† 0 th√¨ ƒëi·ªÉm l√† 0.
                }
            }
            return { achievedScore: parseFloat(achievedScore.toFixed(2)), maxScore: parseFloat(maxScore.toFixed(2)) };
        }


        window.loadResults = async () => {
            const id = document.getElementById('result-exam-id').value.trim().toUpperCase();
            if (!id) return customAlert("Vui l√≤ng nh·∫≠p M√£ ƒê·ªÅ!");
            const btn = document.querySelector('button[onclick="loadResults()"]');
            btn.disabled = true; btn.innerText = "ƒêang t·∫£i...";

            try {
                // 1. T·∫£i Metadata & Results
                const examSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', id));
                if (!examSnap.exists()) throw new Error("M√£ ƒë·ªÅ kh√¥ng t·ªìn t·∫°i.");
                const examMetadata = examSnap.data();
                const resultsSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', id));
                const results = resultsSnap.data()?.results || [];

                if (results.length === 0) {
                    document.getElementById('results-table-container').innerHTML = '<p class="text-center text-gray-500 py-4">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>';
                    document.getElementById('results-charts-analysis').classList.add('hidden');
                    return;
                }

                // 2. T·∫£i chi ti·∫øt c√°c c√¢u h·ªèi (ƒë·ªÉ l·∫•y max score)
                const qProms = [];
                for (let i = 0; i < examMetadata.question_count; i++) qProms.push(getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${id}_${i}`)));
                const questions = (await Promise.all(qProms)).map(s => s.data());

                // 3. Ph√¢n t√≠ch d·ªØ li·ªáu chi ti·∫øt
                const totalStudents = results.length;
                const questionCount = questions.length;
                let questionCorrectCounts = Array(questionCount).fill(0);
                let detailedScores = []; // L∆∞u ƒëi·ªÉm chi ti·∫øt t·ª´ng c√¢u c·ªßa t·ª´ng th√≠ sinh

                results.forEach((r, rIndex) => {
                    r.detailed_answers = r.detailed_answers || []; // L·∫•y ƒë√°p √°n chi ti·∫øt n·∫øu c√≥
                    let studentRow = { name: r.name, class: r.class_, score: r.score, violation_count: r.violation_count || 0, question_scores: [] };
                    
                    questions.forEach((q, qIndex) => {
                        const studentAnswers = r.detailed_answers[qIndex]?.answers || {}; // L·∫•y ƒë√°p √°n c·ªßa th√≠ sinh cho c√¢u n√†y
                        const scores = calculateDetailedScore(q, studentAnswers, examMetadata.scoring);
                        
                        studentRow.question_scores.push(scores);

                        // TƒÉng bi·∫øn ƒë·∫øm n·∫øu ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa (l√†m ƒë√∫ng ho√†n to√†n)
                        if (scores.achievedScore === scores.maxScore && scores.maxScore > 0) {
                            questionCorrectCounts[qIndex]++;
                        }
                    });
                    detailedScores.push(studentRow);
                });

                // 4. B√°o c√°o T·ªâ l·ªá l√†m ƒë√∫ng theo C√¢u h·ªèi (Bi·ªÉu ƒë·ªì c·ªôt)
                const questionLabels = questions.map((_, i) => `C√¢u ${i + 1}`);
                const correctnessPercentages = questionCorrectCounts.map(count => (count / totalStudents) * 100);

                if (window.questionCorrectnessChartInstance) window.questionCorrectnessChartInstance.destroy();
                window.questionCorrectnessChartInstance = new Chart(document.getElementById('questionCorrectnessChart'), {
                    type: 'bar',
                    data: {
                        labels: questionLabels,
                        datasets: [{
                            label: 'T·ªâ l·ªá l√†m ƒë√∫ng (%)',
                            data: correctnessPercentages,
                            backgroundColor: '#3B82F6',
                            borderColor: '#1D4ED8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'Ph·∫ßn trƒÉm th√≠ sinh ƒë√∫ng' }
                            }
                        }
                    }
                });

                // 5. B·∫£ng th·ªëng k√™ chi ti·∫øt ƒëi·ªÉm t·ª´ng c√¢u (H√¨nh tr√≤n m√†u)
                let detailedTableHtml = `<table class="w-full text-sm text-left text-gray-700">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 sticky left-0 bg-gray-100 w-40">Th√≠ sinh</th>
                            <th class="px-4 py-3 text-right">T·ªïng ƒëi·ªÉm</th>
                            ${questionLabels.map(label => `<th class="px-2 py-3 text-center">${label}</th>`).join('')}
                        </tr>
                        <tr>
                            <th class="px-4 py-1 sticky left-0 bg-gray-200 w-40">ƒêi·ªÉm t·ªëi ƒëa</th>
                            <th class="px-4 py-1 text-right font-bold">${examMetadata.question_count > 0 ? questions.reduce((sum, q) => sum + calculateDetailedScore(q, {}, examMetadata.scoring).maxScore, 0).toFixed(2) : 'N/A'}</th>
                            ${questions.map(q => `<th class="px-2 py-1 text-center bg-gray-200">${calculateDetailedScore(q, {}, examMetadata.scoring).maxScore.toFixed(2)}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>`;
                
                detailedScores.forEach(row => {
                    detailedTableHtml += `<tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 sticky left-0 bg-white">${row.name} (${row.class})</td>
                        <td class="px-4 py-3 text-right font-bold text-primary">${row.score.toFixed(2)}</td>
                        ${row.question_scores.map(qs => {
                            const max = qs.maxScore;
                            const achieved = qs.achievedScore;
                            let color = 'bg-red-500'; // ƒê·ªè (0 ƒëi·ªÉm)
                            if (achieved === max) color = 'bg-green-500'; // Xanh l√° (ƒêi·ªÉm t·ªëi ƒëa)
                            else if (achieved > 0 && achieved < max) color = 'bg-yellow-500'; // V√†ng (Kh√¥ng t·ªëi ƒëa)

                            return `<td class="px-2 py-2 text-center">
                                <span class="score-circle ${color}" title="ƒê·∫°t: ${achieved} / ${max}">
                                    ${achieved.toFixed(2)}
                                </span>
                            </td>`;
                        }).join('')}
                    </tr>`;
                });
                detailedTableHtml += '</tbody></table>';
                document.getElementById('detailed-score-table').innerHTML = detailedTableHtml;
                
                // 6. B·∫£ng k·∫øt qu·∫£ t·ªïng h·ª£p (c√≥ th√™m c·ªôt Vi ph·∫°m)
                let tableHtml = `<table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-3">H·∫°ng</th>
                            <th class="px-4 py-3">T√™n</th>
                            <th class="px-4 py-3">L·ªõp</th>
                            <th class="px-4 py-3 text-right">ƒêi·ªÉm</th>
                            <th class="px-4 py-3 text-center">S·ªë l·ªói VP</th> </tr>
                    </thead>
                    <tbody>`;
                results.sort((a, b) => b.score - a.score).forEach((r, i) => {
                    tableHtml += `<tr class="bg-white border-b">
                        <td class="px-4 py-3 font-bold">${i+1}</td>
                        <td class="px-4 py-3">${r.name}</td>
                        <td class="px-4 py-3">${r.class}</td>
                        <td class="px-4 py-3 text-right font-bold text-primary">${parseFloat(r.score).toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">${r.violation_count || 0}</td> </tr>`;
                });
                tableHtml += '</tbody></table>';
                tableHtml += `<div class="mt-4 text-right"><button onclick="exportResultsToExcel()" class="btn bg-green-600 text-xs">Xu·∫•t Excel</button></div>`;
                document.getElementById('results-table-container').innerHTML = tableHtml;
                
                // 7. C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì t·ªïng ƒëi·ªÉm (ph√¢n b·ªë ƒëi·ªÉm)
                if (window.scoreChartInstance) window.scoreChartInstance.destroy();
                window.scoreChartInstance = new Chart(document.getElementById('scoreChart'), { 
                    type: 'bar', 
                    data: { 
                        labels: ['0-2', '2-4', '4-6', '6-8', '8-10'], 
                        datasets: [{ 
                            label: 'S·ªë l∆∞·ª£ng th√≠ sinh', 
                            data: [0,0,0,0,0].map((_,i)=>{
                                return results.filter(r=>{
                                    const s=r.score;
                                    if(i===0)return s<2;
                                    if(i===1)return s>=2&&s<4;
                                    if(i===2)return s>=4&&s<6;
                                    if(i===3)return s>=6&&s<8;
                                    return s>=8
                                }).length
                            }), 
                            backgroundColor: '#3B82F6' 
                        }] 
                    } 
                });
                
                document.getElementById('results-charts-analysis').classList.remove('hidden');
                renderLaTeX(document.getElementById('results-charts-analysis'));

            } catch (e) { 
                customAlert("L·ªói t·∫£i k·∫øt qu·∫£: " + e.message); 
                document.getElementById('results-charts-analysis').classList.add('hidden');
            } finally { 
                btn.disabled = false; btn.innerText = "Xem"; 
            }
        };

        // NEW: H√†m xu·∫•t Excel
        window.exportResultsToExcel = () => {
             const id = document.getElementById('result-exam-id').value.trim().toUpperCase();
             const table = document.getElementById('results-table-container').querySelector('table');
             if (table) {
                 XLSX.writeFile(XLSX.utils.table_to_book(table, {sheet:'KQ'}), `KetQua_${id}_VP.xlsx`);
             } else {
                 customAlert("Kh√¥ng t√¨m th·∫•y b·∫£ng k·∫øt qu·∫£ ƒë·ªÉ xu·∫•t.");
             }
         };

        // --- STUDENT VIEW LOGIC (Unchanged for this request) ---
        window.checkExam = async () => {
            const id = document.getElementById('s-exam-id').value.toUpperCase();
            if(!id) return;
            const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_exams', id));
            if(!snap.exists()) return customAlert("M√£ ƒë·ªÅ sai!");
            currentExamData = snap.data(); currentExamData.id = id;
            document.getElementById('student-entry').classList.add('hidden');
            document.getElementById('student-info-form').classList.remove('hidden');
            document.getElementById('exam-info-display').innerText = `${currentExamData.subject} - ${currentExamData.teacher}`;
        }

        window.setupAntiCheat = () => {
            violationCount = 0;
            const MAX_VIOLATIONS = 3;
            const warn = (msg) => {
                violationCount++;
                document.getElementById('violation-display').innerHTML = `Vi ph·∫°m: <b class="text-red-600">${violationCount}/${MAX_VIOLATIONS}</b>`;
                if(violationCount < MAX_VIOLATIONS) alert(`‚ö†Ô∏è C·∫¢NH B√ÅO GIAN L·∫¨N (${violationCount}/${MAX_VIOLATIONS}): ${msg}`);
                else { alert("üö´ VI PH·∫†M QU√Å M·ª®C. N·ªòP B√ÄI NGAY!"); submitExam(); }
            };
            document.addEventListener("visibilitychange", () => { if (document.hidden) warn("R·ªùi m√†n h√¨nh"); });
            document.addEventListener("contextmenu", (e) => e.preventDefault());
            document.addEventListener("copy", (e) => e.preventDefault());
            document.onkeydown = (e) => { if(e.keyCode==123 || (e.ctrlKey && e.shiftKey && (e.keyCode=='I'.charCodeAt(0) || e.keyCode=='C'.charCodeAt(0)))) return false; };
        };

        window.startExam = async (e) => {
            const name = document.getElementById('s-name').value.trim();
            if (!name) return customAlert("Nh·∫≠p t√™n!");
            e.target.innerText = "ƒêang t·∫£i ƒë·ªÅ...";
            try {
                const qProms = [];
                for(let i=0; i<currentExamData.question_count; i++) qProms.push(getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_questions', `${currentExamData.id}_${i}`)));
                currentExamData.questions = (await Promise.all(qProms)).map(s => s.data());
                
                const container = document.getElementById('exam-questions-render'); container.innerHTML = '';
                document.getElementById('display-s-name').innerText = name;
                setupAntiCheat();

                currentExamData.questions.forEach((q, i) => {
                    let content = q.img_data ? `<img src="data:image/png;base64,${q.img_data}" class="max-h-64 mx-auto mb-4 border">` : `<div class="p-4 bg-blue-50 border-l-4 border-blue-500 mb-4">${marked.parse(q.text_content)}</div>`;
                    let input = '';
                    
                    if(q.type === 'mcq') {
                        const keys = ['A','B','C','D'];
                        input = `<div class="flex flex-col gap-2">
                            ${keys.map(key => {
                                const text = (q.options && q.options[key]) ? q.options[key] : `ƒê√°p √°n ${key}`;
                                return `<div id="opt-row-${i}-${key}" onclick="selectOpt(${i},'${key}')" class="mcq-option">
                                    <span class="mcq-label">${key}.</span>
                                    <span>${text}</span>
                                </div>`;
                            }).join('')}
                        </div><input type="hidden" id="ans-${i}">`;
                    } else if (q.type === 'short_answer') input = `<input type="text" id="ans-${i}" class="input-field mt-2 border-2" placeholder="Tr·∫£ l·ªùi...">`;
                    else if (q.type === 'true_false') {
                         input = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">${(q.tf_options||['a','b','c','d']).map((t,j)=>`<div class="border p-2 flex justify-between bg-white items-center text-sm"><span>${t}</span><label class="flex items-center gap-2"><input type="checkbox" id="tf-${i}-${j}" class="w-5 h-5 accent-green-600"> ƒê√∫ng</label></div>`).join('')}</div>`;
                    }

                    const div = document.createElement('div'); div.className = "card mb-8 border-t-4 border-indigo-500";
                    div.innerHTML = `<div class="flex justify-between mb-3"><h4 class="font-bold bg-gray-200 px-3 py-1 rounded-full">C√¢u ${i+1}</h4><span class="text-xs font-bold text-gray-400 uppercase">${q.type}</span></div>${content}${input}`;
                    container.appendChild(div);
                });
                
                document.getElementById('student-info-form').classList.add('hidden');
                document.getElementById('taking-exam').classList.remove('hidden');
                
                renderLaTeX(document.getElementById('taking-exam')); // Render LaTeX cho to√†n b·ªô ph·∫ßn thi

                let time = currentExamData.time * 60;
                examTimer = setInterval(() => {
                    document.getElementById('timer').innerText = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`;
                    if(time <= 0) { clearInterval(examTimer); alert("H·∫æT GI·ªú!"); submitExam(); }
                    time--;
                }, 1000);
            } catch(e) { customAlert("L·ªói t·∫£i ƒë·ªÅ: " + e.message); e.target.innerText = "B·∫ÆT ƒê·∫¶U"; }
        }

        window.selectOpt = (i, o) => {
            ['A','B','C','D'].forEach(k => { const el = document.getElementById(`opt-row-${i}-${k}`); if(el) el.classList.remove('selected'); });
            const clicked = document.getElementById(`opt-row-${i}-${o}`); if(clicked) clicked.classList.add('selected');
            document.getElementById(`ans-${i}`).value = o;
        }

        window.submitExam = async () => {
             clearInterval(examTimer);
             document.getElementById('btn-submit').disabled = true; document.getElementById('btn-submit').innerText = "ƒêang ch·∫•m...";
             let score = 0; 
             const sc = currentExamData.scoring || { mcq:0.25, sa:0.5, tf_4:1.0, tf_1:0.1 };
             const { allow_score, allow_solution } = currentExamData; 
             let detailedReportHtml = '';
             let studentAnswersData = []; // M·∫£ng l∆∞u tr·ªØ c√¢u tr·∫£ l·ªùi chi ti·∫øt c·ªßa h·ªçc sinh
             
             // 1. T√≠nh ƒëi·ªÉm v√† t·∫°o b√°o c√°o chi ti·∫øt
             currentExamData.questions.forEach((q, i) => {
                 let studentAnswerDisplay = 'Ch∆∞a tr·∫£ l·ªùi';
                 let correctAnswerDisplay = '';
                 let isCorrect = false;
                 
                 let currentQAnswers = {};
                 
                 if (q.type === 'mcq') {
                     const studentChoice = document.getElementById(`ans-${i}`)?.value;
                     currentQAnswers.mcq = studentChoice;
                     
                     studentAnswerDisplay = studentChoice || 'Ch∆∞a ch·ªçn';
                     correctAnswerDisplay = q.answer;
                     isCorrect = (studentChoice === q.answer);
                     if (studentChoice) studentAnswerDisplay = `${studentChoice} <span class="${isCorrect ? 'text-green-500' : 'text-red-500'}">(ƒê√°p √°n c·ªßa b·∫°n)</span>`;
                     
                     if(isCorrect) score += sc.mcq;
                 } else if (q.type === 'short_answer') {
                     const studentText = document.getElementById(`ans-${i}`)?.value;
                     currentQAnswers.sa = studentText;

                     studentAnswerDisplay = studentText || 'Ch∆∞a nh·∫≠p';
                     correctAnswerDisplay = q.answer;
                     isCorrect = (studentText?.trim().toLowerCase() === q.answer.toLowerCase());
                     
                     if(isCorrect) score += sc.sa;
                 } else if (q.type === 'true_false') {
                     let studentChoices = [];
                     let correctAnswers = q.answers || [];
                     let correctCount = 0;
                     
                     let studentTF = [];

                     for (let j = 0; j < (q.tf_options?.length || 4); j++) {
                         let studentChoice = document.getElementById(`tf-${i}-${j}`)?.checked ? 'ƒê' : 'S';
                         studentTF.push(studentChoice);

                         studentChoices.push(`√ù ${['a','b','c','d'][j]}: ${studentChoice}`);
                         if (studentChoice === correctAnswers[j]) correctCount++;
                     }
                     currentQAnswers.tf = studentTF;
                     
                     studentAnswerDisplay = studentChoices.join(' | ');
                     correctAnswerDisplay = (q.tf_options || []).map((t, j) => `√ù ${['a','b','c','d'][j]}: ${correctAnswers[j]}`).join(' | ');
                     
                     if(correctAnswers.length > 0) {
                         if(correctCount === 1) score += sc.tf_1; else if(correctCount === 2) score += sc.tf_2; else if(correctCount === 3) score += sc.tf_3; else if(correctCount === 4) score += sc.tf_4;
                         isCorrect = (correctCount === correctAnswers.length && correctCount > 0);
                     }
                 }
                 
                 studentAnswersData.push({ answers: currentQAnswers });

                 const statusClass = isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50';
                 const statusText = isCorrect ? 'ƒê√öNG' : 'SAI';

                 detailedReportHtml += `
                     <div class="p-4 border-l-4 rounded ${statusClass}">
                         <h5 class="font-bold mb-2 text-lg text-gray-800">C√¢u ${i + 1}: <span class="text-sm font-semibold">${statusText} (${isCorrect ? (sc.mcq||sc.sa||sc.tf_4).toFixed(2) : '0.00'} ƒëi·ªÉm)</span></h5>
                         
                         <div class="bg-white p-3 rounded shadow-sm text-sm">
                             ${q.img_data ? `<img src="data:image/png;base64,${q.img_data}" class="max-h-32 object-contain mb-2">` : `<div class="font-medium">${marked.parse(q.text_content)}</div>`}
                             
                             <p class="mt-2"><strong>ƒê√°p √°n c·ªßa b·∫°n:</strong> ${studentAnswerDisplay}</p>
                             <p class="mt-1 text-green-700"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctAnswerDisplay}</p>
                             
                             <details class="mt-3">
                                 <summary class="cursor-pointer font-bold text-blue-600">L·ªùi gi·∫£i chi ti·∫øt</summary>
                                 <div class="mt-2 p-2 border-t pt-2">${q.explanation ? marked.parse(q.explanation) : 'Kh√¥ng c√≥ l·ªùi gi·∫£i chi ti·∫øt.'}</div>
                             </details>
                         </div>
                     </div>
                 `;
             });

             // 2. C·∫≠p nh·∫≠t Firebase (L∆∞u c·∫£ violation count v√† detailed answers)
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'itex_results', currentExamData.id), {
                 results: arrayUnion({ 
                     name: document.getElementById('s-name').value, 
                     class: document.getElementById('s-class').value, 
                     school: document.getElementById('s-school').value, 
                     score: score, 
                     submittedAt: new Date().toISOString(),
                     violation_count: violationCount, // NEW: S·ªë l·ªói vi ph·∫°m
                     detailed_answers: studentAnswersData // NEW: ƒê√°p √°n chi ti·∫øt
                 })
             });

             // 3. Hi·ªÉn th·ªã k·∫øt qu·∫£ d·ª±a tr√™n quy·ªÅn h·∫°n
             document.getElementById('taking-exam').classList.add('hidden'); 
             document.getElementById('student-result').classList.remove('hidden');

             if (allow_score) {
                 document.getElementById('final-score').innerText = score.toFixed(2);
             } else {
                 document.getElementById('score-display-box').innerHTML = '<p class="text-xl font-bold text-red-500">Gi√°o vi√™n ƒë√£ **kh√≥a** t√≠nh nƒÉng xem ƒëi·ªÉm.</p>';
             }

             if (allow_solution && allow_score) { 
                 document.getElementById('report-details-container').innerHTML = detailedReportHtml;
                 document.getElementById('report-title').innerText = 'üìú K·∫øt Qu·∫£ Chi Ti·∫øt T·ª´ng C√¢u üìú';
                 renderLaTeX(document.getElementById('report-details-container')); 
             } else if (allow_score && !allow_solution) {
                 document.getElementById('report-details-container').innerHTML = '<p class="text-center italic text-gray-500 p-4 border rounded">T√≠nh nƒÉng xem l·ªùi gi·∫£i chi ti·∫øt ƒë√£ b·ªã **kh√≥a**.</p>';
                 document.getElementById('report-title').innerText = 'üìú T√≥m T·∫Øt B√†i L√†m üìú';
             } else {
                 document.getElementById('report-details-container').innerHTML = '<p class="text-center italic text-gray-500 p-4 border rounded">K·∫øt qu·∫£ chi ti·∫øt v√† l·ªùi gi·∫£i ƒë√£ b·ªã **kh√≥a**.</p>';
                 document.getElementById('report-title').innerText = 'üìú B√†i L√†m ƒê√£ ƒê∆∞·ª£c N·ªôp üìú';
             }
        }
    </script>
</body>
</html>
